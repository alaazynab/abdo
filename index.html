<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة الأطباء المطور v3.0 مع Supabase - Enhanced Physicians Management System with Supabase</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .glassmorphism {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        .hidden { display: none !important; }
        
        .modal { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.6); 
            z-index: 1000; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        .status-active { background-color: #dcfce7; color: #166534; }
        .status-annual { background-color: #dbeafe; color: #1e40af; }
        .status-sick { background-color: #fef3c7; color: #92400e; }
        
        .notification { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            max-width: 400px; 
            z-index: 2000; 
            padding: 1rem; 
            color: white; 
            border-radius: 12px;
            animation: slideIn 0.4s ease;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        
        .notification.success { background: linear-gradient(135deg, #10b981, #059669); }
        .notification.warning { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .notification.error { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .notification.info { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .dashboard-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 2px solid #e5e7eb;
            transition: all 0.3s ease;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .main-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 2.5rem;
            color: white;
        }

        .data-icon { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .control-icon { background: linear-gradient(135deg, #10b981, #059669); }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .mode-card {
            background: white;
            border-radius: 20px;
            padding: 3rem;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 3px solid transparent;
        }

        .mode-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            border-color: #3b82f6;
        }

        .mode-card.selected {
            border-color: #10b981;
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
        }

        /* Auth Tabs */
        .auth-tabs {
            display: flex;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 2rem;
        }

        .auth-tab {
            flex: 1;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            transition: all 0.3s ease;
            border-radius: 10px 10px 0 0;
        }

        .auth-tab.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-bottom: 2px solid #10b981;
        }

        .auth-tab:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Loading State */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* User Info Display */
        .user-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            color: white;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .password-strength {
            margin-top: 5px;
            font-size: 12px;
        }
        
        .strength-weak { color: #ef4444; }
        .strength-medium { color: #f59e0b; }
        .strength-strong { color: #10b981; }

        /* جدول الإجازات المرئي */
        .leave-calendar {
            overflow-x: auto;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .leave-calendar table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        .leave-calendar th,
        .leave-calendar td {
            border: 1px solid #e5e7eb;
            padding: 8px;
            text-align: center;
            position: relative;
        }
        
        .leave-calendar th {
            background: #f8fafc;
            font-weight: 600;
            font-size: 11px;
            color: #374151;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .doctor-name-cell {
            background: #f8fafc !important;
            font-weight: 600;
            text-align: right !important;
            padding: 12px 8px;
            min-width: 200px;
            position: sticky;
            right: 0;
            z-index: 5;
            border-left: 2px solid #d1d5db;
        }
        
        .leave-cell {
            width: 40px;
            height: 40px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .leave-cell:hover {
            transform: scale(1.1);
            z-index: 15;
        }
        
        .leave-annual {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }
        
        .leave-sick {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        
        .leave-empty {
            background: #ffffff;
            border: 1px solid #e5e7eb;
        }
        
        .leave-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 20;
            pointer-events: none;
            max-width: 300px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        
        .week-header {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            height: 60px;
        }
        
        .period-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .period-btn {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            font-weight: 500;
        }
        
        .period-btn:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
        }
        
        .period-btn.active {
            border-color: #3b82f6;
            background: #3b82f6;
            color: white;
        }

        /* Column Editor */
        .column-editor {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .column-item {
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8fafc;
        }

        .column-item.dragging {
            opacity: 0.5;
        }

        .sortable-list {
            min-height: 100px;
        }

        .drag-handle {
            cursor: move;
            color: #6b7280;
        }

        .drag-handle:hover {
            color: #374151;
        }

        .column-config-section {
            background: #f8fafc;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .column-config-section h4 {
            margin-bottom: 15px;
            color: #1f2937;
            font-weight: 600;
        }

        /* Report Progress */
        .report-progress {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            color: white;
            display: none;
        }

        .progress-bar {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            height: 20px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            background: linear-gradient(90deg, #10b981, #34d399);
            height: 100%;
            border-radius: 5px;
            transition: width 0.3s ease;
            width: 0%;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .auth-tabs {
                flex-direction: column;
            }
            
            .leave-calendar {
                font-size: 10px;
            }
            
            .leave-cell {
                width: 30px;
                height: 30px;
            }
            
            .doctor-name-cell {
                min-width: 150px;
                font-size: 12px;
            }
            
            .period-selector {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div id="authScreen" class="min-h-screen flex items-center justify-center p-6">
        <div class="glassmorphism p-10 w-full max-w-md">
            <div class="text-center mb-8">
                <i class="fas fa-user-md text-6xl text-white mb-4"></i>
                <h1 class="text-3xl font-bold text-white mb-2">نظام إدارة الأطباء المطور v3.0</h1>
                <p class="text-blue-100">Enhanced Physicians Management System</p>
                <p class="text-xs text-blue-200 mt-2">مع مصادقة Supabase آمنة ومحسنة</p>
            </div>

            <div class="auth-tabs">
                <div class="auth-tab active" onclick="switchAuthTab('signin')">
                    <i class="fas fa-sign-in-alt mr-2"></i>
                    تسجيل دخول
                </div>
                <div class="auth-tab" onclick="switchAuthTab('signup')">
                    <i class="fas fa-user-plus mr-2"></i>
                    حساب جديد
                </div>
            </div>

            <div id="signinForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-white mb-2">البريد الإلكتروني - Email</label>
                    <input type="email" id="signinEmail" 
                           class="w-full p-3 border-0 rounded-lg bg-white bg-opacity-90 focus:bg-opacity-100 focus:outline-none focus:ring-4 focus:ring-blue-300"
                           placeholder="doctor@example.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-white mb-2">كلمة المرور - Password</label>
                    <div class="relative">
                        <input type="password" id="signinPassword" 
                               class="w-full p-3 border-0 rounded-lg bg-white bg-opacity-90 focus:bg-opacity-100 focus:outline-none focus:ring-4 focus:ring-blue-300"
                               placeholder="كلمة المرور">
                        <button type="button" id="toggleSigninPassword" class="absolute left-3 top-3 text-gray-600" onclick="togglePasswordVisibility('signinPassword', 'toggleSigninPassword')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <button onclick="signInWithEmail()" id="signinBtn" class="w-full bg-white text-blue-600 py-3 rounded-lg hover:bg-blue-50 font-semibold text-lg transition-all transform hover:scale-105 shadow-lg">
                    <i class="fas fa-sign-in-alt ml-2"></i>
                    تسجيل الدخول - Sign In
                </button>
                <div class="text-center">
                    <button onclick="resetPassword()" class="text-blue-200 hover:text-white text-sm underline">
                        نسيت كلمة المرور؟ - Forgot Password?
                    </button>
                </div>
            </div>

            <div id="signupForm" class="space-y-6 hidden">
                <div>
                    <label class="block text-sm font-medium text-white mb-2">الاسم الكامل - Full Name</label>
                    <input type="text" id="signupName" 
                           class="w-full p-3 border-0 rounded-lg bg-white bg-opacity-90 focus:bg-opacity-100 focus:outline-none focus:ring-4 focus:ring-blue-300"
                           placeholder="د. أحمد محمد">
                </div>
                <div>
                    <label class="block text-sm font-medium text-white mb-2">البريد الإلكتروني - Email</label>
                    <input type="email" id="signupEmail" 
                           class="w-full p-3 border-0 rounded-lg bg-white bg-opacity-90 focus:bg-opacity-100 focus:outline-none focus:ring-4 focus:ring-blue-300"
                           placeholder="doctor@example.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-white mb-2">كلمة المرور - Password</label>
                    <div class="relative">
                        <input type="password" id="signupPassword" 
                               class="w-full p-3 border-0 rounded-lg bg-white bg-opacity-90 focus:bg-opacity-100 focus:outline-none focus:ring-4 focus:ring-blue-300"
                               placeholder="كلمة المرور (8 أحرف على الأقل)"
                               onkeyup="checkPasswordStrength('signupPassword')">
                        <button type="button" id="toggleSignupPassword" class="absolute left-3 top-3 text-gray-600" onclick="togglePasswordVisibility('signupPassword', 'toggleSignupPassword')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div id="passwordStrength" class="password-strength hidden"></div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-white mb-2">تأكيد كلمة المرور - Confirm Password</label>
                    <input type="password" id="signupConfirmPassword" 
                           class="w-full p-3 border-0 rounded-lg bg-white bg-opacity-90 focus:bg-opacity-100 focus:outline-none focus:ring-4 focus:ring-blue-300"
                           placeholder="تأكيد كلمة المرور">
                </div>
                <button onclick="signUpWithEmail()" id="signupBtn" class="w-full bg-white text-green-600 py-3 rounded-lg hover:bg-green-50 font-semibold text-lg transition-all transform hover:scale-105 shadow-lg">
                    <i class="fas fa-user-plus ml-2"></i>
                    إنشاء حساب - Create Account
                </button>
            </div>

            <div id="authLoading" class="hidden text-center py-4">
                <div class="loading-spinner mx-auto mb-2"></div>
                <div class="text-white text-sm">جاري المعالجة... Processing...</div>
            </div>
        </div>
    </div>

    <div id="modeSelectionScreen" class="min-h-screen p-6 hidden">
        <div class="max-w-6xl mx-auto">
            <div class="glassmorphism p-8 mb-8 text-center">
                <h1 class="text-4xl font-bold text-white mb-3">مرحباً بك في نظام إدارة الأطباء المطور v3.0</h1>
                <p class="text-blue-100 text-lg mb-4">Welcome to Enhanced Physicians Management System</p>
                <p class="text-blue-200">اختر الوضع المطلوب للعمل - Choose your working mode</p>
                
                <div id="mainUserInfo" class="user-info inline-flex items-center gap-3 mt-4">
                    <div id="mainUserAvatar" class="user-avatar text-sm"></div>
                    <div class="text-left">
                        <div id="mainUserEmail" class="font-medium text-sm"></div>
                        <div class="text-xs opacity-75">مدير النظام - System Admin</div>
                    </div>
                </div>

                <div class="flex gap-3 justify-center mt-4">
                    <button onclick="showUserProfile()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-user mr-1"></i>
                        الملف الشخصي - Profile
                    </button>
                    <button onclick="showSettingsModal()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-cog mr-1"></i>
                        الإعدادات - Settings
                    </button>
                    <button onclick="signOut()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-sign-out-alt mr-1"></i>
                        تسجيل خروج - Logout
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="mode-card" onclick="openDataMode()">
                    <div class="data-icon main-icon">
                        <i class="fas fa-database"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">إدارة البيانات</h2>
                    <h3 class="text-xl font-semibold text-blue-600 mb-6 text-center">Data Management</h3>
                    <div class="space-y-3 text-gray-600">
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-green-500 ml-3"></i>
                            <span>عرض وتعديل بيانات الأطباء - View & edit doctors data</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-green-500 ml-3"></i>
                            <span>إدارة الإجازات والحالات - Manage leaves & status</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-green-500 ml-3"></i>
                            <span>البحث والفلترة المتقدمة - Advanced search & filtering</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-green-500 ml-3"></i>
                            <span>تخصيص الأعمدة المتقدم - Advanced column customization</span>
                        </div>
                    </div>
                </div>

                <div class="mode-card" onclick="openLeaveCalendarMode()">
                    <div class="control-icon main-icon">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">جدول الإجازات المرئي</h2>
                    <h3 class="text-xl font-semibold text-green-600 mb-6 text-center">Visual Leave Calendar</h3>
                    <div class="space-y-3 text-gray-600">
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-green-500 ml-3"></i>
                            <span>عرض الإجازات بشكل مرئي - Visual leave display</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-green-500 ml-3"></i>
                            <span>تفاصيل عند المرور بالماوس - Hover details</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-green-500 ml-3"></i>
                            <span>عرض حسب الفترة - Period-based view</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-green-500 ml-3"></i>
                            <span>تصدير منسق - Formatted export</span>
                        </div>
                    </div>
                </div>

                <div class="mode-card" onclick="openControlMode()">
                    <div class="control-icon main-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">لوحة التحكم</h2>
                    <h3 class="text-xl font-semibold text-green-600 mb-6 text-center">Control Panel</h3>
                    <div class="space-y-3 text-gray-600">
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-green-500 ml-3"></i>
                            <span>إنشاء التقارير المتقدمة - Generate advanced reports</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-green-500 ml-3"></i>
                            <span>التحليلات والإحصائيات - Analytics & statistics</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-green-500 ml-3"></i>
                            <span>النسخ الاحتياطي والاستيراد - Backup & import</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-green-500 ml-3"></i>
                            <span>إعدادات النظام المتقدمة - Advanced system settings</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="dataManagementMode" class="min-h-screen p-6 hidden">
        <div class="max-w-7xl mx-auto">
            <div class="glassmorphism p-6 mb-6">
                <div class="flex justify-between items-center flex-wrap gap-4">
                    <div>
                        <h1 class="text-3xl font-bold text-white mb-2">إدارة بيانات الأطباء</h1>
                        <p class="text-blue-100">Data Management - Physicians Database</p>
                    </div>
                    <div class="flex gap-3 flex-wrap">
                        <button onclick="exportTableToPDF()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-all">
                            <i class="fas fa-file-pdf mr-1"></i>
                            تصدير PDF
                        </button>
                        <button onclick="showColumnEditor()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-all">
                            <i class="fas fa-columns mr-1"></i>
                            تخصيص الأعمدة
                        </button>
                        <button onclick="showAddDoctorForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-all">
                            <i class="fas fa-plus mr-1"></i>
                            إضافة طبيب
                        </button>
                        <button onclick="showSettingsModal()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg transition-all">
                            <i class="fas fa-cog mr-1"></i>
                            الإعدادات
                        </button>
                        <button onclick="goToModeSelection()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-all">
                            <i class="fas fa-home mr-1"></i>
                            القائمة الرئيسية
                        </button>
                    </div>
                </div>
            </div>

            <div class="glassmorphism p-4 mb-6">
                <div class="relative">
                    <i class="fas fa-search absolute right-4 top-4 text-blue-300"></i>
                    <input type="text" id="searchInput" 
                           placeholder="البحث بالاسم أو رقم الملف أو البريد الإلكتروني... | Search by name, file number or email..." 
                           class="w-full pr-12 pl-6 py-4 border-0 rounded-lg bg-white bg-opacity-90 focus:bg-opacity-100 focus:outline-none focus:ring-4 focus:ring-blue-300 text-lg"
                           onkeyup="searchDoctors()">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow-md p-4 text-center">
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-2">
                        <i class="fas fa-user-check text-xl text-green-600"></i>
                    </div>
                    <div class="text-xs text-gray-500 mb-1">النشطون - Active</div>
                    <div class="text-2xl font-bold text-gray-900" id="activeCount">0</div>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-4 text-center">
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-2">
                        <i class="fas fa-calendar text-xl text-blue-600"></i>
                    </div>
                    <div class="text-xs text-gray-500 mb-1">إجازة دورية - Annual</div>
                    <div class="text-2xl font-bold text-gray-900" id="annualLeaveCount">0</div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-4 text-center">
                    <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-2">
                        <i class="fas fa-user-injured text-xl text-yellow-600"></i>
                    </div>
                    <div class="text-xs text-gray-500 mb-1">إجازة مرضية - Sick</div>
                    <div class="text-2xl font-bold text-gray-900" id="sickLeaveCount">0</div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-4 text-center">
                    <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-2">
                        <i class="fas fa-heartbeat text-xl text-red-600"></i>
                    </div>
                    <div class="text-xs text-gray-500 mb-1">ACLS منتهية - Expired</div>
                    <div class="text-2xl font-bold text-gray-900" id="expiredAclsCount">0</div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-4 text-center">
                    <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-2">
                        <i class="fas fa-users text-xl text-purple-600"></i>
                    </div>
                    <div class="text-xs text-gray-500 mb-1">الإجمالي - Total</div>
                    <div class="text-2xl font-bold text-gray-900" id="totalCount">0</div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="p-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold">قائمة الأطباء - Doctors List (<span id="doctorsCount">0</span>)</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full editable-table" id="doctorsTable">
                        <thead class="bg-gray-50" id="tableHeader">
                        </thead>
                        <tbody id="doctorsTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="leaveCalendarMode" class="min-h-screen p-6 hidden">
        <div class="max-w-full mx-auto">
            <div class="glassmorphism p-6 mb-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-white mb-2">جدول الإجازات المرئي</h1>
                        <p class="text-blue-100">Visual Leave Calendar - Annual Overview</p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="exportLeaveCalendar()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-all">
                            <i class="fas fa-download mr-1"></i>
                            تصدير الجدول
                        </button>
                        <button onclick="exportLeaveCalendarPDF()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-all">
                            <i class="fas fa-file-pdf mr-1"></i>
                            تصدير PDF
                        </button>
                        <button onclick="refreshLeaveCalendar()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-all">
                            <i class="fas fa-sync mr-1"></i>
                            تحديث
                        </button>
                        <button onclick="goToModeSelection()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-all">
                            <i class="fas fa-home mr-1"></i>
                            القائمة الرئيسية
                        </button>
                    </div>
                </div>
            </div>

            <div class="glassmorphism p-4 mb-6">
                <h3 class="text-white font-semibold mb-3">اختر الفترة - Select Period:</h3>
                <div class="period-selector">
                    <button class="period-btn active" onclick="changePeriod('Q1', this)">
                        <i class="fas fa-calendar-alt mr-1"></i>
                        الربع الأول - Q1 (1-13)
                    </button>
                    <button class="period-btn" onclick="changePeriod('Q2', this)">
                        <i class="fas fa-calendar-alt mr-1"></i>
                        الربع الثاني - Q2 (14-26)
                    </button>
                    <button class="period-btn" onclick="changePeriod('Q3', this)">
                        <i class="fas fa-calendar-alt mr-1"></i>
                        الربع الثالث - Q3 (27-39)
                    </button>
                    <button class="period-btn" onclick="changePeriod('Q4', this)">
                        <i class="fas fa-calendar-alt mr-1"></i>
                        الربع الرابع - Q4 (40-52)
                    </button>
                    <button class="period-btn" onclick="changePeriod('H1', this)">
                        <i class="fas fa-calendar mr-1"></i>
                        النصف الأول - H1 (1-26)
                    </button>
                    <button class="period-btn" onclick="changePeriod('H2', this)">
                        <i class="fas fa-calendar mr-1"></i>
                        النصف الثاني - H2 (27-52)
                    </button>
                    <button class="period-btn" onclick="changePeriod('FULL', this)">
                        <i class="fas fa-calendar-check mr-1"></i>
                        السنة كاملة - Full Year (1-52)
                    </button>
                </div>
            </div>

            <div class="glassmorphism p-4 mb-6">
                <h3 class="text-white font-semibold mb-3">المفتاح - Legend:</h3>
                <div class="flex flex-wrap gap-4 text-white">
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 leave-annual rounded"></div>
                        <span>إجازة دورية - Annual Leave</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 leave-sick rounded"></div>
                        <span>إجازة مرضية - Sick Leave</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 leave-empty rounded border border-gray-400"></div>
                        <span>لا توجد إجازة - No Leave</span>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="p-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold">جدول الإجازات للعام <span id="currentYear">2025</span> - Leave Calendar</h3>
                    <p class="text-sm text-gray-600 mt-1">مرر الماوس فوق الخلايا الملونة لرؤية التفاصيل - Hover over colored cells to see details</p>
                </div>
                <div class="leave-calendar">
                    <table id="leaveCalendarTable">
                        <thead id="leaveCalendarHeader">
                        </thead>
                        <tbody id="leaveCalendarBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="controlPanelMode" class="min-h-screen p-6 hidden">
        <div class="max-w-7xl mx-auto">
            <div class="glassmorphism p-6 mb-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-white mb-2">لوحة التحكم والتحليلات</h1>
                        <p class="text-blue-100">Control Panel & Analytics Dashboard</p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="createManualBackup()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-all">
                            <i class="fas fa-download mr-1"></i>
                            نسخة احتياطية
                        </button>
                        <button onclick="showImportBackup()" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg transition-all">
                            <i class="fas fa-upload mr-1"></i>
                            استيراد نسخة
                        </button>
                        <button onclick="showSettingsModal()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-all">
                            <i class="fas fa-cog mr-1"></i>
                            الإعدادات
                        </button>
                        <button onclick="goToModeSelection()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-all">
                            <i class="fas fa-home mr-1"></i>
                            القائمة الرئيسية
                        </button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div class="dashboard-card">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-chart-bar text-2xl text-blue-600"></i>
                        </div>
                        <h3 class="text-lg font-semibold mb-2">التقارير المتقدمة</h3>
                        <p class="text-sm text-gray-600 mb-4">Advanced Reports</p>
                        <button onclick="toggleReportBuilder()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                            إنشاء تقرير
                        </button>
                    </div>
                </div>

                <div class="dashboard-card">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-chart-pie text-2xl text-green-600"></i>
                        </div>
                        <h3 class="text-lg font-semibold mb-2">التحليلات</h3>
                        <p class="text-sm text-gray-600 mb-4">Analytics Dashboard</p>
                        <button onclick="showAdvancedAnalytics()" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                            عرض التحليلات
                        </button>
                    </div>
                </div>

                <div class="dashboard-card">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-database text-2xl text-purple-600"></i>
                        </div>
                        <h3 class="text-lg font-semibold mb-2">إدارة البيانات</h3>
                        <p class="text-sm text-gray-600 mb-4">Data Management</p>
                        <div class="space-y-2">
                            <button onclick="exportAllData()" class="w-full bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm">
                                تصدير البيانات
                            </button>
                            <button onclick="showUploadModal()" class="w-full bg-orange-600 hover:bg-orange-700 text-white px-3 py-1 rounded text-sm">
                                استيراد ملف
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="reportBuilder" class="glassmorphism p-6 mb-6 hidden">
                <h3 class="text-xl font-semibold text-white mb-4">منشئ التقارير المخصصة - Custom Report Builder</h3>
                <div class="bg-green-600 bg-opacity-20 p-3 rounded-lg mb-4 text-white text-sm">
                    <i class="fas fa-check-circle mr-2"></i>
                    <strong>🔥 نظام تقارير مُصلح ومحسن:</strong> يدعم العربية بشكل مثالي في جميع الصيغ بما في ذلك PDF محسن!
                </div>
                
                <div id="reportProgress" class="report-progress">
                    <div class="flex items-center justify-between mb-2">
                        <span id="progressText">جاري إنشاء التقرير...</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill"></div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="bg-white bg-opacity-10 p-4 rounded-xl">
                        <h4 class="font-semibold text-white mb-3">نوع التقرير - Report Type</h4>
                        <select id="reportType" class="w-full p-3 border-0 rounded-lg bg-white focus:outline-none">
                            <option value="basic">تقرير الأطباء الأساسي - Basic Doctors Report</option>
                            <option value="detailed">تقرير الأطباء المفصل - Detailed Doctors Report</option>
                            <option value="leaves">تقرير إجازات الأطباء - Doctors Leave Report</option>
                            <option value="acls">تقرير شهادات ACLS - ACLS Certificates Report</option>
                            <option value="comprehensive">تقرير شامل للأطباء - Comprehensive Doctors Report</option>
                            <option value="statistics">تقرير الإحصائيات - Statistics Report</option>
                        </select>
                        <p class="text-xs text-blue-200 mt-2">جميع التقارير تدعم العربية مع اسم المركز</p>
                    </div>
                    
                    <div class="bg-white bg-opacity-10 p-4 rounded-xl">
                        <h4 class="font-semibold text-white mb-3">الصيغة - Format</h4>
                        <select id="exportFormat" class="w-full p-3 border-0 rounded-lg bg-white">
                            <option value="excel">Excel (.xlsx) - مُحسّن للعربية ⭐</option>
                            <option value="csv">CSV (.csv) - يدعم العربية ممتاز ✅</option>
                            <option value="pdf">PDF (.pdf) - يدعم العربية 🔥 مُصلح!</option>
                            <option value="json">JSON (.json) - مثالي للعربية 📄</option>
                        </select>
                        <p class="text-xs text-blue-200 mt-2">🔥 جميع الصيغ تدعم النص العربي بشكل مثالي!</p>
                    </div>
                    
                    <div class="bg-white bg-opacity-10 p-4 rounded-xl">
                        <h4 class="font-semibold text-white mb-3">الإجراءات - Actions</h4>
                        <button onclick="generateReport()" class="w-full bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700">
                            <i class="fas fa-download mr-2"></i>
                            إنشاء التقرير
                        </button>
                        <p class="text-xs text-blue-200 mt-2">سيُطلب منك إدخال اسم المركز</p>
                    </div>
                </div>

                <div class="bg-white bg-opacity-10 p-4 rounded-xl mt-4">
                    <h4 class="font-semibold text-white mb-3">المراجع العلمية المضمنة - Included Scientific References</h4>
                    <div class="text-xs text-blue-200 space-y-1">
                        <div>• منظمة الصحة العالمية (WHO) - Global Health Workforce Strategy 2030</div>
                        <div>• جمعية القلب الأمريكية (AHA) - ACLS Provider Manual 2025</div>
                        <div>• معايير الأيزو (ISO) - ISO 27799:2016 Health Informatics Security</div>
                        <div>• وزارة الصحة الكويتية - Digital Transformation Guidelines 2024</div>
                        <div>• معايير إدارة البيانات الطبية (HIPAA) - Updated 2024</div>
                    </div>
                </div>
            </div>

            <div class="glassmorphism p-4">
                <h3 class="text-lg font-semibold text-white mb-3">حالة النظام - System Status</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-white">
                    <div class="bg-white bg-opacity-10 p-3 rounded-lg">
                        <div class="text-sm text-blue-200">آخر نسخة احتياطية - Last Backup</div>
                        <div class="font-semibold" id="lastBackupInfo">لم يتم إنشاء نسخة بعد</div>
                    </div>
                    <div class="bg-white bg-opacity-10 p-3 rounded-lg">
                        <div class="text-sm text-blue-200">عدد الأطباء - Total Doctors</div>
                        <div class="font-semibold" id="totalDoctorsStatus">0</div>
                    </div>
                    <div class="bg-white bg-opacity-10 p-3 rounded-lg">
                        <div class="text-sm text-blue-200">إصدار النظام - System Version</div>
                        <div class="font-semibold">v3.0 Enhanced with Fixed Reports</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="columnEditorModal" class="modal hidden">
        <div class="column-editor">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold">محرر الأعمدة المتقدم - Advanced Column Editor</h3>
                <button onclick="closeColumnEditor()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="column-config-section">
                <h4>إضافة عمود جديد - Add New Column</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="custom-field-input">
                        <label>اسم العمود - Column Name</label>
                        <input type="text" id="newColumnName" placeholder="اسم العمود الجديد">
                    </div>
                    <div class="custom-field-input">
                        <label>الاسم باللغة الإنجليزية - English Name</label>
                        <input type="text" id="newColumnEnglishName" placeholder="English Name">
                    </div>
                </div>
                <div class="field-type-selector">
                    <label>نوع البيانات - Data Type</label>
                    <select id="newColumnType">
                        <option value="text">نص - Text</option>
                        <option value="number">رقم - Number</option>
                        <option value="date">تاريخ - Date</option>
                        <option value="email">بريد إلكتروني - Email</option>
                        <option value="phone">هاتف - Phone</option>
                        <option value="select">قائمة اختيار - Select</option>
                    </select>
                </div>
                <div id="selectOptions" class="custom-field-input hidden">
                    <label>خيارات القائمة (مفصولة بفاصلة) - Options (comma separated)</label>
                    <input type="text" id="selectOptionsList" placeholder="خيار 1, خيار 2, خيار 3">
                </div>
                <button onclick="addNewColumn()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-plus mr-1"></i>
                    إضافة العمود
                </button>
            </div>

            <div class="column-config-section">
                <h4>التحكم السريع في الأعمدة - Quick Column Controls</h4>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                    <button onclick="addAllAvailableColumns()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
                        <i class="fas fa-plus-circle mr-1"></i>
                        إضافة جميع المتوفرة
                    </button>
                    <button onclick="removeAllCustomColumns()" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg text-sm">
                        <i class="fas fa-minus-circle mr-1"></i>
                        حذف المخصصة
                    </button>
                    <button onclick="resetToDefaultColumns()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg text-sm">
                        <i class="fas fa-undo mr-1"></i>
                        الافتراضية فقط
                    </button>
                    <button onclick="removeAllColumns()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm">
                        <i class="fas fa-trash mr-1"></i>
                        حذف الجميع
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="column-config-section">
                    <h4>الأعمدة المتاحة - Available Columns</h4>
                    <div class="space-y-2 max-h-80 overflow-y-auto" id="availableColumnsList">
                    </div>
                </div>

                <div class="column-config-section">
                    <h4>الأعمدة المعروضة - Displayed Columns</h4>
                    <div id="displayedColumnsList" class="space-y-2 max-h-80 overflow-y-auto sortable-list">
                    </div>
                </div>
            </div>

            <div class="mt-6 flex gap-4">
                <button onclick="saveColumnConfiguration()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg">
                    <i class="fas fa-save mr-1"></i>
                    حفظ التكوين
                </button>
                <button onclick="resetColumnConfiguration()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-2 rounded-lg">
                    <i class="fas fa-undo mr-1"></i>
                    إعادة تعيين
                </button>
                <button onclick="closeColumnEditor()" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg">
                    إلغاء
                </button>
            </div>
        </div>
    </div>

    <div id="addDoctorModal" class="modal hidden">
        <div class="glassmorphism p-8 w-full max-w-4xl mx-4 max-h-screen overflow-y-auto">
            <h3 class="text-2xl font-semibold text-white mb-8">إضافة طبيب جديد - Add New Doctor</h3>
            <div id="doctorFormFields" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            </div>
            <div class="flex gap-6 mt-8">
                <button onclick="saveDoctorData()" class="bg-green-600 hover:bg-green-700 text-white px-8 py-4 rounded-lg">
                    حفظ البيانات - Save Data
                </button>
                <button onclick="closeAddDoctorModal()" class="bg-gray-600 hover:bg-gray-700 text-white px-8 py-4 rounded-lg">
                    إلغاء - Cancel
                </button>
            </div>
        </div>
    </div>

    <div id="editDoctorModal" class="modal hidden">
        <div class="glassmorphism p-8 w-full max-w-4xl mx-4 max-h-screen overflow-y-auto">
            <h3 class="text-2xl font-semibold text-white mb-8">تعديل بيانات الطبيب - Edit Doctor Data</h3>
            <div id="editDoctorFormFields" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            </div>
            <div class="flex gap-6 mt-8">
                <button onclick="updateDoctorData()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-lg">
                    تحديث البيانات - Update Data
                </button>
                <button onclick="deleteDoctor()" class="bg-red-600 hover:bg-red-700 text-white px-8 py-4 rounded-lg">
                    حذف الطبيب - Delete Doctor
                </button>
                <button onclick="closeEditDoctorModal()" class="bg-gray-600 hover:bg-gray-700 text-white px-8 py-4 rounded-lg">
                    إلغاء - Cancel
                </button>
            </div>
        </div>
    </div>

    <div id="leaveModal" class="modal hidden">
        <div class="glassmorphism p-8 w-full max-w-md mx-4">
            <h3 id="leaveModalTitle" class="text-xl font-semibold text-white mb-6">إضافة إجازة - Add Leave</h3>
            <div class="space-y-5">
                <div>
                    <label class="block text-sm font-medium text-blue-100 mb-2">اسم الطبيب - Doctor Name</label>
                    <input type="text" id="leaveDoctorName" disabled class="w-full p-3 border-0 rounded-lg bg-white bg-opacity-80">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-blue-100 mb-2">تاريخ البداية - Start Date</label>
                        <input type="date" id="leaveStartDate" class="w-full p-3 border-0 rounded-lg bg-white" onchange="updateLeaveDays()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-blue-100 mb-2">تاريخ النهاية - End Date</label>
                        <input type="date" id="leaveEndDate" class="w-full p-3 border-0 rounded-lg bg-white" onchange="updateLeaveDays()">
                    </div>
                </div>
                <div id="leaveDaysDisplay" class="text-sm text-blue-100 bg-white bg-opacity-10 p-3 rounded-lg hidden">
                    عدد الأيام - Days Count: <span id="leaveDaysCount" class="font-bold text-white">0</span> يوم - days
                </div>
                <div>
                    <label class="block text-sm font-medium text-blue-100 mb-2">السبب - Reason</label>
                    <textarea id="leaveReason" rows="3" class="w-full p-3 border-0 rounded-lg bg-white" placeholder="اكتب سبب الإجازة... | Write the leave reason..."></textarea>
                </div>
            </div>
            <div class="flex gap-4 mt-8">
                <button onclick="addLeave()" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg">
                    إضافة الإجازة - Add Leave
                </button>
                <button onclick="closeLeaveModal()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg">
                    إلغاء - Cancel
                </button>
            </div>
        </div>
    </div>

    <div id="uploadModal" class="modal hidden">
        <div class="glassmorphism p-8 w-full max-w-2xl mx-4">
            <h3 class="text-2xl font-semibold text-white mb-8">رفع وثائق الأطباء - Upload Physician Documents</h3>
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-blue-100 mb-2">رفع ملف Excel للأطباء - Upload Excel File</label>
                    <input type="file" id="uploadExcelFile" accept=".xlsx,.xls" class="w-full p-3 border-0 rounded-lg bg-white">
                    <p class="text-xs text-blue-100 mt-2">يمكنك رفع ملف Excel يحتوي على بيانات الأطباء - You can upload an Excel file containing physician data</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-blue-100 mb-2">رفع ملف CSV للأطباء - Upload CSV File</label>
                    <input type="file" id="uploadCSVFile" accept=".csv" class="w-full p-3 border-0 rounded-lg bg-white">
                    <p class="text-xs text-blue-100 mt-2">يمكنك رفع ملف CSV يحتوي على بيانات الأطباء - You can upload a CSV file containing physician data</p>
                </div>
                <div class="bg-white bg-opacity-10 p-4 rounded-lg">
                    <h4 class="text-white font-semibold mb-2">تنسيق الملف المطلوب - Required File Format:</h4>
                    <p class="text-blue-100 text-sm">الأعمدة المطلوبة - Required Columns: الاسم، الرقم المدني، رقم الملف، الشهادة، التليفون، البريد الشخصي، البريد الحكومي، تاريخ انتهاء ACLS، المسمى الوظيفي</p>
                    <p class="text-blue-100 text-sm mt-2">Name, Civil ID, File Number, Degree, Phone, Personal Email, Government Email, ACLS Expiry Date, Job Title</p>
                </div>
            </div>
            <div class="flex gap-6 mt-8">
                <button onclick="processUploadedFile()" class="bg-green-600 hover:bg-green-700 text-white px-8 py-4 rounded-lg">
                    <i class="fas fa-upload ml-2"></i>
                    رفع ومعالجة الملف - Upload & Process File
                </button>
                <button onclick="closeUploadModal()" class="bg-gray-600 hover:bg-gray-700 text-white px-8 py-4 rounded-lg">
                    إلغاء - Cancel
                </button>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal hidden">
        <div class="glassmorphism p-8 w-full max-w-lg mx-4">
            <h3 class="text-2xl font-semibold text-white mb-8">إعدادات النظام - System Settings</h3>
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-blue-100 mb-2">المستخدم الحالي - Current User</label>
                    <input type="text" id="currentUsername" disabled class="w-full p-3 border-0 rounded-lg bg-gray-200">
                </div>
                <div>
                    <label class="block text-sm font-medium text-blue-100 mb-2">تجديد كلمة المرور - Change Password</label>
                    <div class="relative">
                        <input type="password" id="newPassword" class="w-full p-3 border-0 rounded-lg bg-white" placeholder="كلمة المرور الجديدة" onkeyup="checkPasswordStrength('newPassword')">
                        <div id="newPasswordStrength" class="password-strength hidden"></div>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-blue-100 mb-2">تأكيد كلمة المرور - Confirm Password</label>
                    <input type="password" id="confirmPassword" class="w-full p-3 border-0 rounded-lg bg-white" placeholder="تأكيد كلمة المرور الجديدة">
                </div>
            </div>
            <div class="flex gap-6 mt-8">
                <button onclick="updateSettings()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-lg">
                    حفظ الإعدادات - Save Settings
                </button>
                <button onclick="closeSettingsModal()" class="bg-gray-600 hover:bg-gray-700 text-white px-8 py-4 rounded-lg">
                    إلغاء - Cancel
                </button>
            </div>
        </div>
    </div>

    <div id="analyticsModal" class="modal hidden">
        <div class="glassmorphism p-8 w-full max-w-6xl mx-4 max-h-screen overflow-y-auto text-white">
             <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-semibold">لوحة التحليلات - Analytics Dashboard</h3>
                <button onclick="closeAnalyticsModal()" class="text-white hover:text-gray-300">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="bg-white bg-opacity-20 p-4 rounded-xl">
                    <h4 class="text-lg font-bold mb-4 text-center">حالة الأطباء</h4>
                    <canvas id="statusChart"></canvas>
                </div>
                <div class="bg-white bg-opacity-20 p-4 rounded-xl">
                    <h4 class="text-lg font-bold mb-4 text-center">حالة شهادة ACLS</h4>
                    <canvas id="aclsChart"></canvas>
                </div>
                <div class="bg-white bg-opacity-20 p-4 rounded-xl">
                    <h4 class="text-lg font-bold mb-4 text-center">المسميات الوظيفية</h4>
                    <canvas id="jobTitleChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div id="doctorDocumentsModal" class="modal hidden">
        <div class="glassmorphism p-8 w-full max-w-2xl mx-4 text-white">
            <div class="flex justify-between items-center mb-6">
                <h3 id="documentsModalTitle" class="text-2xl font-semibold">وثائق الطبيب</h3>
                <button onclick="closeDoctorDocumentsModal()" class="text-white hover:text-gray-300">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div class="bg-white bg-opacity-20 p-4 rounded-xl mb-6">
                <h4 class="font-semibold mb-3">إضافة وثيقة جديدة</h4>
                <div class="flex gap-4">
                    <input type="file" id="doctorDocumentInput" class="w-full p-3 border-0 rounded-lg bg-white text-gray-800">
                    <button onclick="addDoctorDocument()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg">
                        <i class="fas fa-upload mr-2"></i>رفع
                    </button>
                </div>
                <p class="text-xs text-blue-200 mt-2">ملاحظة: النظام لا يقوم بتخزين الملفات، فقط أسماء الملفات كمرجع.</p>
            </div>
            <div>
                <h4 class="font-semibold mb-3">الوثائق المرفوعة</h4>
                <div id="doctorDocumentsList" class="space-y-2 max-h-60 overflow-y-auto">
                    </div>
            </div>
        </div>
    </div>


    <div id="leaveTooltip" class="leave-tooltip hidden"></div>
    <input type="file" id="backupFileInput" accept=".json" class="hidden" onchange="processBackupFile()">

    <script>
        /**
         * نظام إدارة الأطباء المطور v3.0 مع مصادقة Supabase آمنة
         * Enhanced Physicians Management System with Secure Supabase Authentication
         */

        // === SUPABASE CONFIGURATION - إعداد Supabase ===
        const SUPABASE_URL = 'https://gwnzqfmnvplwnaydwelt.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd3bnpxZm1udnBsd25heWR3ZWx0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3MTk2MDgsImV4cCI6MjA3MDI5NTYwOH0.pPpQTflowGs5_WY4m7FBRhiaz8DJMnMvABwiyeswYXo';
        
        // إعدادات الصلاحيات
        const USER_PERMISSIONS = {
            FULL_ACCESS: ['abdo@post.com', 'qasercenter@gmail.com'],
            READ_ONLY: ['phcjahra@gmail.com']
        };
        
        // تهيئة Supabase client
        let supabase = null;
        
        if (SUPABASE_URL && SUPABASE_ANON_KEY) {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('✅ Supabase initialized successfully');
            } catch (error) {
                console.warn('❌ Supabase initialization failed:', error);
                supabase = null;
            }
        }

        // === Global Variables - المتغيرات العامة ===
        let doctors = [];
        let currentUser = null;
        let currentUserPermissions = 'read_only';
        let currentLeaveDoctor = null;
        let currentLeaveType = '';
        let currentEditingDoctor = null;
        let currentPeriod = 'Q1';
        let currentDoctorForDocuments = null;
        let activeCharts = {};

        // Enhanced Column Configuration
        let displayedColumns = [
            { key: 'name', label: 'الاسم - Name', enabled: true, type: 'text' },
            { key: 'civilId', label: 'الرقم المدني - Civil ID', enabled: true, type: 'text' },
            { key: 'fileNumber', label: 'رقم الملف - File Number', enabled: true, type: 'text' },
            { key: 'jobTitle', label: 'المسمى الوظيفي - Job Title', enabled: true, type: 'text' },
            { key: 'phone', label: 'التليفون - Phone', enabled: true, type: 'phone' },
            { key: 'aclsExpiryDate', label: 'تاريخ انتهاء ACLS', enabled: true, type: 'date' },
            { key: 'currentStatus', label: 'الحالة - Status', enabled: true, type: 'select' },
            { key: 'documents', label: 'الوثائق - Documents', enabled: true, type: 'documents', editable: false },
            { key: 'actions', label: 'الإجراءات - Actions', enabled: true, type: 'actions' }
        ];

        // System Settings
        let systemSettings = {
            autoBackup: true,
            aclsNotifications: true,
            emailNotifications: true,
            bilingualReports: true,
            lastBackup: null,
            arabicSupport: true,
            scientificReferences: true
        };

        // Enhanced Sample Data
        const sampleDoctors = [
            {
                id: '1',
                name: 'د. أحمد محمد الصالح - Dr. Ahmed Mohammed Al-Saleh',
                civilId: '123456789',
                fileNumber: 'MD001',
                degree: 'بكالوريوس طب وجراحة - MBBS',
                phone: '+965-12345678',
                personalEmail: 'ahmed.alsaleh@gmail.com',
                governmentEmail: 'ahmed.alsaleh@moh.gov.kw',
                aclsExpiryDate: '2025-12-15',
                jobTitle: 'طبيب عام - General Practitioner',
                currentStatus: 'active',
                annualLeaveBalance: 20,
                sickLeaveBalance: 90,
                address: 'منطقة السالمية، شارع سالم المبارك، بناية 15، شقة 3',
                emergencyContact: 'فاطمة الصالح - Fatima Al-Saleh',
                emergencyPhone: '+965-99887766',
                nationality: 'كويتي - Kuwaiti',
                birthDate: '1985-03-15',
                hireDate: '2015-09-01',
                department: 'الطب العام - General Medicine',
                workShift: 'morning',
                specialization: 'طب الأسرة - Family Medicine',
                medicalLicense: 'ML-KW-2015-001234',
                licenseExpiry: '2027-09-01',
                salary: 1200,
                bankAccount: 'KW81CBKU0000000000001234567890',
                notes: 'طبيب متميز مع خبرة 10 سنوات - Excellent doctor with 10 years experience',
                leaves: [
                    {
                        id: 'leave_1',
                        type: 'annual',
                        startDate: '2025-03-15',
                        endDate: '2025-03-22',
                        days: 7,
                        reason: 'إجازة دورية - Annual vacation',
                        createdAt: '2025-03-01T10:00:00.000Z'
                    }
                ],
                documents: [
                    { name: 'CV.pdf', uploadedAt: '2025-01-10T10:00:00Z' },
                    { name: 'Medical_License.pdf', uploadedAt: '2025-01-11T11:30:00Z' }
                ]
            },
            {
                id: '2',
                name: 'د. فاطمة علي الزهراني - Dr. Fatima Ali Al-Zahrani',
                civilId: '987654321',
                fileNumber: 'MD002',
                degree: 'ماجستير طب الأطفال - MSc Pediatrics',
                phone: '+965-87654321',
                personalEmail: 'fatima.alzahrani@outlook.com',
                governmentEmail: 'fatima.alzahrani@moh.gov.kw',
                aclsExpiryDate: '2026-03-20',
                jobTitle: 'طبيبة أطفال - Pediatrician',
                currentStatus: 'active',
                annualLeaveBalance: 25,
                sickLeaveBalance: 76,
                leaves: [],
                documents: []
            }
        ];

        // === AUTHENTICATION FUNCTIONS - دوال المصادقة ===

        function getUserPermissions(email) {
            if (USER_PERMISSIONS.FULL_ACCESS.includes(email)) {
                return 'full_access';
            } else if (USER_PERMISSIONS.READ_ONLY.includes(email)) {
                return 'read_only';
            }
            return 'no_access';
        }

        function hasPermission(action) {
            if (currentUserPermissions === 'full_access') {
                return true;
            }
            const readOnlyActions = ['view', 'search', 'export', 'read'];
            if (currentUserPermissions === 'read_only' && readOnlyActions.includes(action)) {
                return true;
            }
            return false;
        }

        function showPermissionDenied() {
            showNotification(
                '🚫 عذراً، ليس لديك صلاحية لتنفيذ هذا الإجراء\n' +
                'تواصل مع المدير للحصول على صلاحيات إضافية\n' +
                'Sorry, you don\'t have permission for this action',
                'warning'
            );
        }

        function switchAuthTab(tab) {
            const signinForm = document.getElementById('signinForm');
            const signupForm = document.getElementById('signupForm');
            const tabs = document.querySelectorAll('.auth-tab');
            
            tabs.forEach(t => t.classList.remove('active'));
            
            if (tab === 'signin') {
                signinForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
                tabs[0].classList.add('active');
            } else {
                signinForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
                tabs[1].classList.add('active');
            }
        }

        function getNameFromEmail(email) {
            const nameMap = {
                'abdo@post.com': 'عبدو - Abdo',
                'qasercenter@gmail.com': 'مركز قيصر - Qaser Center',
                'phcjahra@gmail.com': 'مركز الجهراء - Jahra PHC',
                'admin@system.com': 'مدير النظام - System Admin'
            };
            return nameMap[email] || email.split('@')[0];
        }

        async function signInWithEmail() {
            const email = document.getElementById('signinEmail').value.trim();
            const password = document.getElementById('signinPassword').value;
            const btn = document.getElementById('signinBtn');

            if (!email || !password) {
                showNotification('يرجى إدخال البريد الإلكتروني وكلمة المرور - Please enter email and password', 'error');
                return;
            }

            if (!isValidEmail(email)) {
                showNotification('البريد الإلكتروني غير صحيح - Invalid email format', 'error');
                return;
            }

            const userPermission = getUserPermissions(email);
            if (userPermission === 'no_access') {
                showNotification(
                    '🚫 عذراً، ليس لديك صلاحية للوصول إلى النظام\n' +
                    'تواصل مع المدير: abdo@post.com أو qasercenter@gmail.com\n' +
                    'Sorry, you don\'t have access to the system',
                    'error'
                );
                return;
            }

            showAuthLoading(true);
            btn.disabled = true;

            try {
                if (supabase) {
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email: email,
                        password: password
                    });

                    if (error) {
                        throw new Error(error.message);
                    }

                    if (data.user) {
                        currentUser = data.user;
                        currentUserPermissions = userPermission;
                        await handleSuccessfulAuth(data.user);
                        
                        const permissionText = userPermission === 'full_access' ? 
                            '👑 صلاحيات كاملة - Full Access' : 
                            '👁️ صلاحيات قراءة فقط - Read Only Access';
                            
                        showNotification(
                            `🩺 مرحباً بك في نظام إدارة الأطباء المطور v3.0!\n` +
                            `✅ تم تسجيل الدخول بنجاح عبر Supabase\n` +
                            `${permissionText}\n` +
                            `🔒 مصادقة آمنة ومحسنة`,
                            'success', 6000
                        );
                    }
                } else {
                    const validEmails = [
                        'admin@system.com',
                        ...USER_PERMISSIONS.FULL_ACCESS,
                        ...USER_PERMISSIONS.READ_ONLY
                    ];
                    
                    if (validEmails.includes(email)) {
                        currentUser = {
                            id: 'demo-user-' + Date.now(),
                            email: email,
                            user_metadata: { full_name: getNameFromEmail(email) },
                            created_at: new Date().toISOString(),
                            last_sign_in_at: new Date().toISOString(),
                            email_confirmed_at: new Date().toISOString()
                        };
                        currentUserPermissions = userPermission;
                        await handleSuccessfulAuth(currentUser);
                        
                        const permissionText = userPermission === 'full_access' ? 
                            '👑 صلاحيات كاملة' : 
                            '👁️ صلاحيات قراءة فقط';
                            
                        showNotification(
                            `🎯 مرحباً بك في النظام!\n` +
                            `✅ تم تسجيل الدخول بنجاح\n` +
                            `${permissionText}\n` +
                            `💡 نظام تجريبي بدون Supabase`,
                            'success', 6000
                        );
                    } else {
                        throw new Error('بيانات تسجيل الدخول غير صحيحة - Invalid credentials');
                    }
                }
            } catch (error) {
                console.error('Sign in error:', error);
                let errorMessage = 'خطأ في تسجيل الدخول - Sign in error';
                
                if (error.message.includes('Invalid login credentials')) {
                    errorMessage = 'البريد الإلكتروني أو كلمة المرور غير صحيحة - Invalid email or password';
                } else if (error.message.includes('Email not confirmed')) {
                    errorMessage = 'يرجى تأكيد البريد الإلكتروني أولاً - Please confirm your email first';
                } else if (error.message.includes('network')) {
                    errorMessage = 'خطأ في الاتصال بالخادم - Network connection error';
                }
                
                showNotification(errorMessage, 'error');
            } finally {
                showAuthLoading(false);
                btn.disabled = false;
            }
        }

        async function signUpWithEmail() {
            const name = document.getElementById('signupName').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;
            const btn = document.getElementById('signupBtn');

            if (!name || !email || !password || !confirmPassword) {
                showNotification('يرجى ملء جميع الحقول - Please fill all fields', 'error');
                return;
            }

            if (!isValidEmail(email)) {
                showNotification('البريد الإلكتروني غير صحيح - Invalid email format', 'error');
                return;
            }

            if (password.length < 8) {
                showNotification('كلمة المرور يجب أن تكون 8 أحرف على الأقل - Password must be at least 8 characters', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showNotification('كلمة المرور غير متطابقة - Passwords do not match', 'error');
                return;
            }

            showAuthLoading(true);
            btn.disabled = true;

            try {
                if (supabase) {
                    const { data, error } = await supabase.auth.signUp({
                        email: email,
                        password: password,
                        options: {
                            data: {
                                full_name: name,
                                role: 'physician',
                                system_access: 'basic'
                            }
                        }
                    });

                    if (error) {
                        throw new Error(error.message);
                    }

                    if (data.user) {
                        showNotification(
                            `✅ تم إنشاء الحساب بنجاح!\n` +
                            `📧 يرجى فحص بريدك الإلكتروني لتأكيد الحساب\n` +
                            `ثم قم بتسجيل الدخول\n` +
                            `Account created successfully!`,
                            'success', 8000
                        );
                        
                        switchAuthTab('signin');
                        
                        ['signupName', 'signupEmail', 'signupPassword', 'signupConfirmPassword'].forEach(id => {
                            document.getElementById(id).value = '';
                        });
                    }
                } else {
                    showNotification(
                        `⚠️ Supabase غير متوفر حالياً\n` +
                        `إنشاء الحسابات متاح فقط عبر Supabase\n` +
                        `تواصل مع المدير لإنشاء حساب جديد`,
                        'warning', 6000
                    );
                }
            } catch (error) {
                console.error('Sign up error:', error);
                let errorMessage = 'خطأ في إنشاء الحساب - Account creation error';
                
                if (error.message.includes('already registered')) {
                    errorMessage = 'البريد الإلكتروني مسجل مسبقاً - Email already registered';
                } else if (error.message.includes('weak password')) {
                    errorMessage = 'كلمة المرور ضعيفة - Password too weak';
                }
                
                showNotification(errorMessage, 'error');
            } finally {
                showAuthLoading(false);
                btn.disabled = false;
            }
        }

        async function resetPassword() {
            const email = document.getElementById('signinEmail').value.trim();
            
            if (!email) {
                showNotification('يرجى إدخال البريد الإلكتروني أولاً - Please enter your email first', 'warning');
                return;
            }

            if (!isValidEmail(email)) {
                showNotification('البريد الإلكتروني غير صحيح - Invalid email format', 'error');
                return;
            }

            try {
                if (supabase) {
                    const { error } = await supabase.auth.resetPasswordForEmail(email, {
                        redirectTo: window.location.origin + '#reset-password'
                    });

                    if (error) {
                        throw new Error(error.message);
                    }

                    showNotification(
                        `📧 تم إرسال رابط إعادة تعيين كلمة المرور\n` +
                        `يرجى فحص بريدك الإلكتروني`,
                        'info', 6000
                    );
                } else {
                    showNotification(
                        'إعادة تعيين كلمة المرور متاحة فقط عبر Supabase',
                        'warning'
                    );
                }
            } catch (error) {
                console.error('Password reset error:', error);
                showNotification('خطأ في إرسال رابط إعادة التعيين - Error sending reset link', 'error');
            }
        }

        async function signOut() {
            try {
                if (supabase && currentUser) {
                    const { error } = await supabase.auth.signOut();
                    if (error) {
                        console.warn('Sign out error:', error);
                    }
                }

                currentUser = null;
                currentUserPermissions = 'read_only';
                
                ['modeSelectionScreen', 'dataManagementMode', 'leaveCalendarMode', 'controlPanelMode'].forEach(screen => {
                    const element = document.getElementById(screen);
                    if (element) element.classList.add('hidden');
                });

                document.getElementById('authScreen').classList.remove('hidden');
                
                ['signinEmail', 'signinPassword'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.value = '';
                });

                showNotification('تم تسجيل الخروج بنجاح - Successfully signed out', 'info');
            } catch (error) {
                console.error('Sign out error:', error);
                showNotification('خطأ في تسجيل الخروج - Sign out error', 'error');
            }
        }

        async function handleSuccessfulAuth(user) {
            currentUser = user;
            
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('modeSelectionScreen').classList.remove('hidden');
            
            updateUserInfo(user);
            await initializeSystem();
        }

        function updateUserInfo(user) {
            const email = user.email || 'user@example.com';
            const name = user.user_metadata?.full_name || user.user_metadata?.name || getNameFromEmail(email);
            const initials = getInitials(name);
            const permissionText = currentUserPermissions === 'full_access' ? 
                'مدير النظام - System Admin' : 
                'مستخدم قراءة - Read Only User';

            const mainUserEmail = document.getElementById('mainUserEmail');
            const mainUserAvatar = document.getElementById('mainUserAvatar');
            
            if (mainUserEmail) mainUserEmail.textContent = email;
            if (mainUserAvatar) mainUserAvatar.textContent = initials;

            const permissionDisplay = document.querySelector('#mainUserInfo .text-xs');
            if (permissionDisplay) {
                permissionDisplay.textContent = permissionText;
            }
        }

        function showAuthLoading(show) {
            const loading = document.getElementById('authLoading');
            const signinForm = document.getElementById('signinForm');
            const signupForm = document.getElementById('signupForm');
            
            if (show) {
                loading.classList.remove('hidden');
                signinForm.classList.add('loading');
                signupForm.classList.add('loading');
            } else {
                loading.classList.add('hidden');
                signinForm.classList.remove('loading');
                signupForm.classList.remove('loading');
            }
        }

        async function checkAuthState() {
            try {
                if (supabase) {
                    const { data: { session } } = await supabase.auth.getSession();
                    
                    if (session?.user) {
                        currentUser = session.user;
                        currentUserPermissions = getUserPermissions(session.user.email);
                        await handleSuccessfulAuth(session.user);
                        return true;
                    }
                }
                return false;
            } catch (error) {
                console.error('Auth state check error:', error);
                return false;
            }
        }

        function setupAuthListener() {
            if (supabase) {
                supabase.auth.onAuthStateChange(async (event, session) => {
                    console.log('Auth state changed:', event);
                    
                    if (event === 'SIGNED_IN' && session?.user) {
                        currentUser = session.user;
                        currentUserPermissions = getUserPermissions(session.user.email);
                        await handleSuccessfulAuth(session.user);
                    } else if (event === 'SIGNED_OUT') {
                        currentUser = null;
                        currentUserPermissions = 'read_only';
                        document.getElementById('authScreen').classList.remove('hidden');
                        ['modeSelectionScreen', 'dataManagementMode', 'leaveCalendarMode', 'controlPanelMode'].forEach(screen => {
                            const element = document.getElementById(screen);
                            if (element) element.classList.add('hidden');
                        });
                    }
                });
            }
        }

        // === UTILITY FUNCTIONS - الدوال المساعدة ===

        function togglePasswordVisibility(inputId, buttonId) {
            const passwordInput = document.getElementById(inputId);
            const toggleButton = document.getElementById(buttonId);
            const icon = toggleButton.querySelector('i');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        function showNotification(message, type = 'success', duration = 4000) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };
            
            const timestamp = new Date().toLocaleTimeString('ar-EG');
            
            notification.innerHTML = `
                <div class="flex items-center gap-3">
                    <i class="${icons[type] || icons.info} text-xl"></i>
                    <div class="flex-1">
                        <div class="font-medium">${message}</div>
                        <div class="text-xs opacity-75 mt-1">${timestamp}</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, duration);
        }

        function formatDate(date, locale = 'ar-EG') {
            if (!date) return 'غير محدد - Not specified';
            try {
                const gregorianDate = new Date(date);
                if (isNaN(gregorianDate.getTime())) {
                    return 'تاريخ غير صحيح - Invalid date';
                }
                
                const arabicDate = gregorianDate.toLocaleDateString('ar-EG');
                const englishDate = gregorianDate.toLocaleDateString('en-GB');
                
                return systemSettings.bilingualReports ? 
                    `${arabicDate} - ${englishDate}` : 
                    englishDate;
            } catch (error) {
                console.error('Date formatting error:', error);
                return 'تاريخ غير صحيح - Invalid date';
            }
        }

        function checkPasswordStrength(inputId) {
            const password = document.getElementById(inputId).value;
            const strengthDiv = document.getElementById(inputId === 'signupPassword' ? 'passwordStrength' : 'newPasswordStrength');

            if (!password) {
                if (strengthDiv) strengthDiv.classList.add('hidden');
                return;
            }

            let strength = 0;
            let feedback = [];

            if (password.length >= 8) strength++;
            else feedback.push('8 أحرف على الأقل - At least 8 characters');

            if (/[A-Z]/.test(password)) strength++;
            else feedback.push('حرف كبير - Uppercase letter');

            if (/[a-z]/.test(password)) strength++;
            else feedback.push('حرف صغير - Lowercase letter');

            if (/\d/.test(password)) strength++;
            else feedback.push('رقم - Number');

            if (/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) strength++;
            else feedback.push('رمز خاص - Special character');

            if (strengthDiv) {
                strengthDiv.classList.remove('hidden');

                if (strength < 3) {
                    strengthDiv.className = 'password-strength strength-weak';
                    strengthDiv.textContent = `ضعيف - Weak: ${feedback.slice(0, 2).join(', ')}`;
                } else if (strength < 5) {
                    strengthDiv.className = 'password-strength strength-medium';
                    strengthDiv.textContent = 'متوسط - Medium';
                } else {
                    strengthDiv.className = 'password-strength strength-strong';
                    strengthDiv.textContent = 'قوي - Strong';
                }
            }
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function getInitials(name) {
            if (!name) return 'U';
            
            const words = name.split(' ').filter(word => word.length > 0);
            if (words.length === 1) {
                return words[0].charAt(0).toUpperCase();
            }
            
            return words.slice(0, 2).map(word => word.charAt(0).toUpperCase()).join('');
        }

        // === NAVIGATION FUNCTIONS - دوال التنقل ===

        function openDataMode() {
            document.getElementById('modeSelectionScreen').classList.add('hidden');
            document.getElementById('dataManagementMode').classList.remove('hidden');
            updateDataDisplay();
            updateUIBasedOnPermissions();
        }

        function openLeaveCalendarMode() {
            document.getElementById('modeSelectionScreen').classList.add('hidden');
            document.getElementById('leaveCalendarMode').classList.remove('hidden');
            generateLeaveCalendar();
            updateUIBasedOnPermissions();
        }

        function openControlMode() {
            if (!hasPermission('admin')) {
                showPermissionDenied();
                return;
            }
            document.getElementById('modeSelectionScreen').classList.add('hidden');
            document.getElementById('controlPanelMode').classList.remove('hidden');
        }

        function goToModeSelection() {
            ['dataManagementMode', 'leaveCalendarMode', 'controlPanelMode'].forEach(mode => {
                document.getElementById(mode).classList.add('hidden');
            });
            document.getElementById('modeSelectionScreen').classList.remove('hidden');
        }

        function updateUIBasedOnPermissions() {
            if (currentUserPermissions === 'read_only') {
                const editButtons = document.querySelectorAll('[onclick*="edit"], [onclick*="add"], [onclick*="delete"], [onclick*="save"], [onclick*="update"]');
                editButtons.forEach(btn => {
                    if (btn) {
                        btn.style.display = 'none';
                    }
                });

                showReadOnlyNotification();
            }
        }

        function showReadOnlyNotification() {
            const notification = document.createElement('div');
            notification.className = 'fixed top-0 left-0 right-0 bg-yellow-500 text-white text-center py-2 z-50';
            notification.innerHTML = `
                <i class="fas fa-eye mr-2"></i>
                وضع القراءة فقط - صلاحياتك محدودة للعرض والبحث والتصدير فقط
                Read-Only Mode - Limited to viewing, searching, and exporting only
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 10000);
        }

        // === SYSTEM MANAGEMENT FUNCTIONS - دوال إدارة النظام ===

        function initializeSystem() {
            try {
                loadData();
                loadSettings();
                loadColumnConfiguration();
                checkACLSExpirations();
                console.log('✅ System initialization completed');
            } catch (error) {
                console.error('System initialization failed:', error);
                showNotification(
                    '⚠️ حدث خطأ في تهيئة النظام الأساسية\n' +
                    'سيتم استخدام الإعدادات الافتراضية',
                    'warning'
                );
                
                try {
                    doctors = [...sampleDoctors];
                    saveData();
                } catch (fallbackError) {
                    console.error('Fallback initialization failed:', fallbackError);
                }
            }
        }

        function loadData() {
            try {
                const savedData = localStorage.getItem('doctorsData');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    if (Array.isArray(parsedData) && validateDoctorsData(parsedData)) {
                        doctors = parsedData;
                    } else {
                        throw new Error('Invalid data format');
                    }
                } else {
                    doctors = [...sampleDoctors];
                    saveData();
                    showNotification('تم تحميل البيانات التجريبية - Sample data loaded', 'info');
                }
            } catch (error) {
                console.error('Data loading error:', error);
                doctors = [...sampleDoctors];
                saveData();
                showNotification('خطأ في تحميل البيانات، تم استخدام البيانات التجريبية', 'warning');
            }
        }

        function validateDoctorsData(data) {
            return data.every(doctor => 
                doctor.id && 
                doctor.name && 
                doctor.civilId && 
                doctor.fileNumber
            );
        }

        function saveData() {
            try {
                localStorage.setItem('doctorsData', JSON.stringify(doctors));
                localStorage.setItem('dataMetadata', JSON.stringify({
                    lastSaved: new Date().toISOString(),
                    version: '3.0',
                    recordCount: doctors.length,
                    userId: currentUser?.id || 'anonymous'
                }));
                console.log('Data saved successfully at', new Date().toLocaleString('ar-EG'));
            } catch (error) {
                console.error('Data saving error:', error);
                showNotification('خطأ في حفظ البيانات - Data saving error', 'error');
            }
        }

        function loadSettings() {
            try {
                const savedSettings = localStorage.getItem('systemSettings');
                if (savedSettings) {
                    const parsedSettings = JSON.parse(savedSettings);
                    systemSettings = { ...systemSettings, ...parsedSettings };
                }
            } catch (error) {
                console.warn('Settings loading error:', error);
            }
        }

        function loadColumnConfiguration() {
            try {
                const savedColumns = localStorage.getItem('columnConfiguration');
                if (savedColumns) {
                    displayedColumns = JSON.parse(savedColumns);
                }
            } catch (error) {
                console.warn('Column configuration loading error:', error);
            }
        }

        function updateDataDisplay() {
            updateStatistics();
            generateTableHeaders();
            displayDoctors();
        }

        function updateStatistics() {
            const today = new Date();
            
            const stats = {
                active: doctors.filter(d => d.currentStatus === 'active').length,
                annualLeave: doctors.filter(d => d.currentStatus === 'annual_leave').length,
                sickLeave: doctors.filter(d => d.currentStatus === 'sick_leave').length,
                total: doctors.length,
                expiredACLS: 0
            };

            doctors.forEach(doctor => {
                if (doctor.aclsExpiryDate) {
                    const expiryDate = new Date(doctor.aclsExpiryDate);
                    if (expiryDate < today) {
                        stats.expiredACLS++;
                    }
                }
            });

            const elements = {
                'activeCount': stats.active,
                'annualLeaveCount': stats.annualLeave,
                'sickLeaveCount': stats.sickLeave,
                'totalCount': stats.total,
                'expiredAclsCount': stats.expiredACLS,
                'doctorsCount': stats.total,
                'totalDoctorsStatus': stats.total
            };

            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
            });
        }

        function generateTableHeaders() {
            const tableHeader = document.getElementById('tableHeader');
            if (!tableHeader) return;
            
            tableHeader.innerHTML = '';
            const headerRow = document.createElement('tr');
            
            displayedColumns.forEach(column => {
                if (column.enabled) {
                    const th = document.createElement('th');
                    th.className = 'px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer';
                    th.innerHTML = `
                        <div class="flex items-center justify-between">
                            <span>${column.label}</span>
                            <i class="fas fa-sort text-gray-400"></i>
                        </div>
                    `;
                    headerRow.appendChild(th);
                }
            });
            
            tableHeader.appendChild(headerRow);
        }

        function displayDoctors(filteredDoctors = null) {
            const tbody = document.getElementById('doctorsTableBody');
            if (!tbody) return;

            const doctorsToShow = filteredDoctors || doctors;
            tbody.innerHTML = '';

            doctorsToShow.forEach(doctor => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';

                displayedColumns.forEach(column => {
                    if (column.enabled) {
                        const cell = document.createElement('td');
                        cell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-900';

                        switch (column.key) {
                            case 'name':
                                cell.innerHTML = `<div class="font-medium">${doctor.name || 'غير محدد'}</div>`;
                                break;
                            case 'currentStatus':
                                const status = getStatusInfo(doctor);
                                cell.innerHTML = `
                                    <span class="px-3 py-1 rounded-full text-xs font-medium ${status.class}">
                                        ${status.icon} ${status.label}
                                    </span>
                                `;
                                break;
                            case 'aclsExpiryDate':
                                const statusInfo = getACLSStatus(doctor.aclsExpiryDate);
                                cell.innerHTML = `
                                    <div class="flex items-center gap-2">
                                        <span class="${statusInfo.class}">${formatDate(doctor.aclsExpiryDate)}</span>
                                        ${statusInfo.icon}
                                    </div>
                                `;
                                break;
                            case 'personalEmail':
                                cell.innerHTML = doctor.personalEmail ? 
                                    `<a href="mailto:${doctor.personalEmail}" class="text-blue-600 hover:text-blue-800">${doctor.personalEmail}</a>` : 
                                    'غير محدد';
                                break;
                            case 'documents':
                                const docCount = doctor.documents ? doctor.documents.length : 0;
                                cell.innerHTML = `
                                    <button onclick="showDoctorDocumentsModal('${doctor.id}')" class="text-indigo-600 hover:text-indigo-800" title="إدارة الوثائق - Manage Documents">
                                        <i class="fas fa-folder-open mr-1"></i> (${docCount})
                                    </button>
                                `;
                                break;
                            case 'actions':
                                if (currentUserPermissions === 'full_access') {
                                    cell.innerHTML = `
                                        <div class="flex gap-2">
                                            <button onclick="editDoctor('${doctor.id}')" class="text-blue-600 hover:text-blue-800" title="تعديل - Edit">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button onclick="addDoctorLeave('${doctor.id}', 'annual')" class="text-green-600 hover:text-green-800" title="إجازة دورية - Annual Leave">
                                                <i class="fas fa-calendar"></i>
                                            </button>
                                            <button onclick="addDoctorLeave('${doctor.id}', 'sick')" class="text-yellow-600 hover:text-yellow-800" title="إجازة مرضية - Sick Leave">
                                                <i class="fas fa-plus-circle"></i>
                                            </button>
                                            <button onclick="resetDoctorStatus('${doctor.id}')" class="text-purple-600 hover:text-purple-800" title="إعادة تعيين الحالة - Reset Status">
                                                <i class="fas fa-undo"></i>
                                            </button>
                                        </div>
                                    `;
                                } else {
                                    cell.innerHTML = `
                                        <div class="flex gap-2">
                                            <button onclick="viewDoctor('${doctor.id}')" class="text-blue-600 hover:text-blue-800" title="عرض - View">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    `;
                                }
                                break;
                            default:
                                const value = doctor[column.key];
                                if (column.type === 'date') {
                                    cell.textContent = formatDate(value);
                                } else if (column.type === 'email' && value) {
                                    cell.innerHTML = `<a href="mailto:${value}" class="text-blue-600 hover:text-blue-800">${value}</a>`;
                                } else {
                                    cell.textContent = value || 'غير متوفر';
                                }
                        }

                        row.appendChild(cell);
                    }
                });

                tbody.appendChild(row);
            });
        }

        function getStatusInfo(doctor) {
            const statusLabels = {
                'active': { 
                    label: 'نشط - Active', 
                    class: 'status-active', 
                    icon: '✓'
                },
                'annual_leave': { 
                    label: 'إجازة دورية - Annual Leave', 
                    class: 'status-annual', 
                    icon: '📅'
                },
                'sick_leave': { 
                    label: 'إجازة مرضية - Sick Leave', 
                    class: 'status-sick', 
                    icon: '🏥'
                }
            };

            return statusLabels[doctor.currentStatus] || statusLabels['active'];
        }

        function getACLSStatus(expiryDate) {
            if (!expiryDate) return { class: 'text-gray-500', icon: '❓' };
            
            const today = new Date();
            const expiry = new Date(expiryDate);
            const daysUntilExpiry = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));

            if (daysUntilExpiry < 0) {
                return { class: 'text-red-600 font-bold', icon: '⚠️' };
            } else if (daysUntilExpiry <= 30) {
                return { class: 'text-yellow-600 font-medium', icon: '⏰' };
            } else {
                return { class: 'text-green-600', icon: '✅' };
            }
        }

        function searchDoctors() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (!searchTerm) {
                displayDoctors();
                return;
            }

            const filteredDoctors = doctors.filter(doctor => {
                return displayedColumns.some(column => {
                    if (!column.enabled || column.key === 'actions') return false;
                    
                    const value = doctor[column.key];
                    if (value && typeof value === 'string') {
                        return value.toLowerCase().includes(searchTerm);
                    }
                    return false;
                });
            });

            displayDoctors(filteredDoctors);
        }

        function checkACLSExpirations() {
            if (!systemSettings.aclsNotifications) return;

            const today = new Date();
            const warningPeriod = 30;

            doctors.forEach(doctor => {
                if (doctor.aclsExpiryDate) {
                    const expiryDate = new Date(doctor.aclsExpiryDate);
                    const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));

                    if (daysUntilExpiry < 0) {
                        showNotification(`⚠️ تنبيه: شهادة ACLS منتهية للطبيب ${doctor.name}`, 'error', 8000);
                    } else if (daysUntilExpiry <= warningPeriod) {
                        showNotification(`⏰ تنبيه: شهادة ACLS ستنتهي خلال ${daysUntilExpiry} يوم للطبيب ${doctor.name}`, 'warning', 6000);
                    }
                }
            });
        }

        // === COLUMN MANAGEMENT FUNCTIONS ===

        function getAllAvailableColumns() {
            return [
                { key: 'name', label: 'الاسم - Name', type: 'text', required: false, editable: true },
                { key: 'civilId', label: 'الرقم المدني - Civil ID', type: 'text', required: false, editable: true },
                { key: 'fileNumber', label: 'رقم الملف - File Number', type: 'text', required: false, editable: true },
                { key: 'degree', label: 'الشهادة - Degree', type: 'text', required: false, editable: true },
                { key: 'jobTitle', label: 'المسمى الوظيفي - Job Title', type: 'text', required: false, editable: true },
                { key: 'phone', label: 'التليفون - Phone', type: 'phone', required: false, editable: true },
                { key: 'personalEmail', label: 'البريد الشخصي - Personal Email', type: 'email', required: false, editable: true },
                { key: 'governmentEmail', label: 'البريد الحكومي - Government Email', type: 'email', required: false, editable: true },
                { key: 'aclsExpiryDate', label: 'تاريخ انتهاء ACLS', type: 'date', required: false, editable: true },
                { key: 'currentStatus', label: 'الحالة - Status', type: 'select', required: false, editable: true, options: ['active', 'annual_leave', 'sick_leave'] },
                { key: 'documents', label: 'الوثائق - Documents', type: 'documents', required: false, editable: false },
                { key: 'actions', label: 'الإجراءات - Actions', type: 'actions', required: false, editable: false }
            ];
        }

        function showColumnEditor() {
            if (!hasPermission('edit')) {
                showPermissionDenied();
                return;
            }
            document.getElementById('columnEditorModal').classList.remove('hidden');
            updateAvailableColumnsList();
            updateDisplayedColumnsList();
        }

        function closeColumnEditor() {
            document.getElementById('columnEditorModal').classList.add('hidden');
        }

        function updateAvailableColumnsList() {
            const list = document.getElementById('availableColumnsList');
            if (!list) return;
            
            list.innerHTML = '';
            
            const allPossibleColumns = getAllAvailableColumns();
            
            allPossibleColumns.forEach(column => {
                const isDisplayed = displayedColumns.find(col => col.key === column.key && col.enabled);
                if (!isDisplayed) {
                    const item = document.createElement('div');
                    item.className = 'column-item';
                    item.innerHTML = `
                        <div class="flex-1">
                            <div class="font-medium">${column.label}</div>
                            <div class="text-sm text-gray-500">${column.key} (${column.type})</div>
                        </div>
                        <button onclick="addExistingColumn('${column.key}')" class="bg-green-500 text-white px-3 py-1 rounded text-sm">
                            <i class="fas fa-plus"></i>
                        </button>
                    `;
                    list.appendChild(item);
                }
            });
        }

        function updateDisplayedColumnsList() {
            const list = document.getElementById('displayedColumnsList');
            if (!list) return;
            
            list.innerHTML = '';
            
            displayedColumns.forEach((column, index) => {
                if (column.enabled) {
                    const item = document.createElement('div');
                    item.className = 'column-item';
                    const isActionColumn = column.key === 'actions' || column.key === 'documents';
                    item.innerHTML = `
                        <div class="flex-1">
                            <div class="font-medium">${column.label}</div>
                            <div class="text-sm text-gray-500">${column.key} (${column.type})</div>
                        </div>
                        <div class="flex gap-2">
                            ${!isActionColumn ? `<button onclick="removeColumn('${column.key}')" class="bg-red-500 text-white px-2 py-1 rounded text-sm"><i class="fas fa-trash"></i></button>` : ''}
                        </div>
                    `;
                    list.appendChild(item);
                }
            });
        }

        function addAllAvailableColumns() {
            if (!hasPermission('edit')) {
                showPermissionDenied();
                return;
            }
            
            const allColumns = getAllAvailableColumns();
            displayedColumns = allColumns.map(col => ({
                ...col,
                enabled: true
            }));
            
            updateAvailableColumnsList();
            updateDisplayedColumnsList();
            showNotification('تم إضافة جميع الأعمدة المتوفرة', 'success');
        }

        function removeAllCustomColumns() {
            if (!hasPermission('edit')) {
                showPermissionDenied();
                return;
            }
            
            const customCount = displayedColumns.filter(col => col.custom).length;
            if (customCount === 0) {
                showNotification('لا توجد أعمدة مخصصة لحذفها', 'info');
                return;
            }
            
            displayedColumns = displayedColumns.filter(col => !col.custom);
            updateAvailableColumnsList();
            updateDisplayedColumnsList();
            showNotification(`تم حذف ${customCount} عمود مخصص`, 'info');
        }

        function resetToDefaultColumns() {
            if (!hasPermission('edit')) {
                showPermissionDenied();
                return;
            }
            
            const defaultColumns = [
                { key: 'name', label: 'الاسم - Name', enabled: true, type: 'text' },
                { key: 'civilId', label: 'الرقم المدني - Civil ID', enabled: true, type: 'text' },
                { key: 'fileNumber', label: 'رقم الملف - File Number', enabled: true, type: 'text' },
                { key: 'jobTitle', label: 'المسمى الوظيفي - Job Title', enabled: true, type: 'text' },
                { key: 'phone', label: 'التليفون - Phone', enabled: true, type: 'phone' },
                { key: 'aclsExpiryDate', label: 'تاريخ انتهاء ACLS', enabled: true, type: 'date' },
                { key: 'currentStatus', label: 'الحالة - Status', enabled: true, type: 'select' },
                { key: 'documents', label: 'الوثائق - Documents', enabled: true, type: 'documents', editable: false },
                { key: 'actions', label: 'الإجراءات - Actions', enabled: true, type: 'actions' }
            ];
            
            displayedColumns = defaultColumns;
            updateAvailableColumnsList();
            updateDisplayedColumnsList();
            showNotification('تم إعادة تعيين الأعمدة للحالة الافتراضية', 'info');
        }

        function removeAllColumns() {
            if (!hasPermission('edit')) {
                showPermissionDenied();
                return;
            }
            
            displayedColumns = [
                { key: 'actions', label: 'الإجراءات - Actions', enabled: true, type: 'actions' }
            ];
            
            updateAvailableColumnsList();
            updateDisplayedColumnsList();
            showNotification('تم حذف جميع الأعمدة عدا الإجراءات', 'warning');
        }

        function addNewColumn() {
            if (!hasPermission('edit')) {
                showPermissionDenied();
                return;
            }
            
            const name = document.getElementById('newColumnName').value.trim();
            const englishName = document.getElementById('newColumnEnglishName').value.trim();
            const type = document.getElementById('newColumnType').value;

            if (!name || !englishName) {
                showNotification('يرجى إدخال اسم العمود باللغتين', 'error');
                return;
            }

            const key = englishName.toLowerCase().replace(/\s+/g, '_');
            const newColumn = {
                key: key,
                label: `${name} - ${englishName}`,
                enabled: true,
                type: type,
                custom: true
            };

            displayedColumns.splice(-1, 0, newColumn);
            updateDisplayedColumnsList();
            
            document.getElementById('newColumnName').value = '';
            document.getElementById('newColumnEnglishName').value = '';
            showNotification('تم إضافة العمود الجديد', 'success');
        }

        function addExistingColumn(columnKey) {
            if (!hasPermission('edit')) {
                showPermissionDenied();
                return;
            }
            
            const allColumns = getAllAvailableColumns();
            const columnToAdd = allColumns.find(col => col.key === columnKey);
            
            if (columnToAdd) {
                displayedColumns.splice(-1, 0, {...columnToAdd, enabled: true});
                updateAvailableColumnsList();
                updateDisplayedColumnsList();
                showNotification(`تم إضافة العمود: ${columnToAdd.label}`, 'success');
            }
        }

        function removeColumn(columnKey) {
            if (!hasPermission('edit')) {
                showPermissionDenied();
                return;
            }
            
            const index = displayedColumns.findIndex(col => col.key === columnKey);
            if (index > -1) {
                const column = displayedColumns[index];
                displayedColumns.splice(index, 1);
                updateAvailableColumnsList();
                updateDisplayedColumnsList();
                showNotification(`تم إزالة العمود: ${column.label}`, 'info');
            }
        }

        function saveColumnConfiguration() {
            if (!hasPermission('edit')) {
                showPermissionDenied();
                return;
            }
            
            try {
                localStorage.setItem('columnConfiguration', JSON.stringify(displayedColumns));
                showNotification('تم حفظ تكوين الأعمدة بنجاح', 'success');
                closeColumnEditor();
                updateDataDisplay();
            } catch (error) {
                console.error('Column configuration saving error:', error);
                showNotification('خطأ في حفظ تكوين الأعمدة', 'error');
            }
        }

        function resetColumnConfiguration() {
            resetToDefaultColumns();
        }

        // === DOCTOR MANAGEMENT FUNCTIONS ===

        function generateDoctorForm(containerId, doctor = null) {
            const container = document.getElementById(containerId);
            if (!container) return;

            container.innerHTML = '';

            const columnsForForm = getAllAvailableColumns().filter(c => c.editable);

            columnsForForm.forEach(column => {
                const fieldDiv = document.createElement('div');
                const value = doctor ? (doctor[column.key] || '') : '';

                fieldDiv.innerHTML = `
                    <label class="block text-sm font-medium text-blue-100 mb-2">${column.label}</label>
                    ${generateInputField(column, value)}
                `;

                container.appendChild(fieldDiv);
            });
        }

        function generateInputField(column, value = '') {
            const id = `${column.key}Input`;
            const placeholder = column.label.split(' - ')[1] || column.label;

            switch (column.type) {
                case 'email':
                    return `<input type="email" id="${id}" value="${value}" class="w-full p-3 border-0 rounded-lg bg-white" placeholder="${placeholder}">`;
                case 'phone':
                    return `<input type="tel" id="${id}" value="${value}" class="w-full p-3 border-0 rounded-lg bg-white" placeholder="+965-12345678">`;
                case 'date':
                    return `<input type="date" id="${id}" value="${value}" class="w-full p-3 border-0 rounded-lg bg-white">`;
                case 'text':
                default:
                    return `<input type="text" id="${id}" value="${value}" class="w-full p-3 border-0 rounded-lg bg-white" placeholder="${placeholder}">`;
            }
        }

        function showAddDoctorForm() {
            if (!hasPermission('add')) {
                showPermissionDenied();
                return;
            }
            generateDoctorForm('doctorFormFields');
            document.getElementById('addDoctorModal').classList.remove('hidden');
        }

        function closeAddDoctorModal() {
            document.getElementById('addDoctorModal').classList.add('hidden');
        }

        function saveDoctorData() {
            if (!hasPermission('add')) {
                showPermissionDenied();
                return;
            }
            
            const newDoctor = {
                id: generateDoctorId(),
                currentStatus: 'active',
                leaves: [],
                documents: [],
                createdAt: new Date().toISOString()
            };

            getAllAvailableColumns().forEach(column => {
                if (!column.editable) return;

                const input = document.getElementById(`${column.key}Input`);
                if (input) {
                    const value = input.value.trim();
                    newDoctor[column.key] = value;
                }
            });

            if (!newDoctor.name && !newDoctor.fileNumber && !newDoctor.civilId) {
                showNotification('يرجى إدخال على الأقل الاسم أو رقم الملف أو الرقم المدني', 'warning');
                return;
            }

            doctors.push(newDoctor);
            saveData();
            updateDataDisplay();
            closeAddDoctorModal();
            
            showNotification(`تم إضافة الطبيب بنجاح: ${newDoctor.name || newDoctor.fileNumber || 'طبيب جديد'}`, 'success');
        }

        function generateDoctorId() {
            return 'DR_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
        }

        function editDoctor(doctorId) {
            if (!hasPermission('edit')) {
                showPermissionDenied();
                return;
            }
            
            const doctor = doctors.find(d => d.id === doctorId);
            if (!doctor) return;

            currentEditingDoctor = doctor;
            generateDoctorForm('editDoctorFormFields', doctor);
            document.getElementById('editDoctorModal').classList.remove('hidden');
        }

        function closeEditDoctorModal() {
            document.getElementById('editDoctorModal').classList.add('hidden');
            currentEditingDoctor = null;
        }

        function updateDoctorData() {
            if (!hasPermission('edit') || !currentEditingDoctor) {
                showPermissionDenied();
                return;
            }

            getAllAvailableColumns().forEach(column => {
                if (!column.editable) return;

                const input = document.getElementById(`${column.key}Input`);
                if (input) {
                    const value = input.value.trim();
                    currentEditingDoctor[column.key] = value;
                }
            });

            currentEditingDoctor.updatedAt = new Date().toISOString();

            saveData();
            updateDataDisplay();
            closeEditDoctorModal();

            showNotification(`تم تحديث بيانات الطبيب بنجاح: ${currentEditingDoctor.name || 'الطبيب'}`, 'success');
        }

        function deleteDoctor() {
            if (!hasPermission('delete') || !currentEditingDoctor) {
                showPermissionDenied();
                return;
            }

            if (confirm(`هل أنت متأكد من حذف الطبيب: ${currentEditingDoctor.name}؟`)) {
                const doctorName = currentEditingDoctor.name;
                doctors = doctors.filter(d => d.id !== currentEditingDoctor.id);
                
                saveData();
                updateDataDisplay();
                closeEditDoctorModal();

                showNotification(`تم حذف الطبيب: ${doctorName}`, 'info');
            }
        }

        function viewDoctor(doctorId) {
            const doctor = doctors.find(d => d.id === doctorId);
            if (doctor) {
                showNotification(`عرض بيانات: ${doctor.name || 'الطبيب'}`, 'info');
            }
        }

        // === DOCUMENT MANAGEMENT FUNCTIONS ===
        function showDoctorDocumentsModal(doctorId) {
            if (!hasPermission('edit')) {
                showPermissionDenied();
                return;
            }
            currentDoctorForDocuments = doctors.find(d => d.id === doctorId);
            if (!currentDoctorForDocuments) return;

            document.getElementById('documentsModalTitle').textContent = `وثائق الطبيب: ${currentDoctorForDocuments.name}`;
            
            const documentsList = document.getElementById('doctorDocumentsList');
            documentsList.innerHTML = '';

            if (currentDoctorForDocuments.documents && currentDoctorForDocuments.documents.length > 0) {
                currentDoctorForDocuments.documents.forEach((doc, index) => {
                    const docElement = document.createElement('div');
                    docElement.className = 'flex justify-between items-center bg-white bg-opacity-10 p-2 rounded';
                    docElement.innerHTML = `
                        <div class="flex items-center gap-3">
                            <i class="fas fa-file-alt text-blue-300"></i>
                            <span>${doc.name}</span>
                            <span class="text-xs text-gray-400">(${new Date(doc.uploadedAt).toLocaleDateString('ar-EG')})</span>
                        </div>
                        <button onclick="removeDoctorDocument(${index})" class="text-red-400 hover:text-red-600">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    documentsList.appendChild(docElement);
                });
            } else {
                documentsList.innerHTML = '<p class="text-center text-gray-400">لا توجد وثائق مرفوعة لهذا الطبيب.</p>';
            }

            document.getElementById('doctorDocumentsModal').classList.remove('hidden');
        }

        function closeDoctorDocumentsModal() {
            document.getElementById('doctorDocumentsModal').classList.add('hidden');
            currentDoctorForDocuments = null;
            document.getElementById('doctorDocumentInput').value = '';
        }

        function addDoctorDocument() {
            if (!currentDoctorForDocuments) return;
            const fileInput = document.getElementById('doctorDocumentInput');
            const file = fileInput.files[0];

            if (!file) {
                showNotification('يرجى اختيار ملف أولاً', 'warning');
                return;
            }

            if (!currentDoctorForDocuments.documents) {
                currentDoctorForDocuments.documents = [];
            }

            currentDoctorForDocuments.documents.push({
                name: file.name,
                uploadedAt: new Date().toISOString()
            });

            saveData();
            showDoctorDocumentsModal(currentDoctorForDocuments.id); // Refresh modal view
            displayDoctors(); // Refresh table view to update count
            fileInput.value = '';
            showNotification(`تمت إضافة الوثيقة: ${file.name}`, 'success');
        }

        function removeDoctorDocument(index) {
            if (!currentDoctorForDocuments || !currentDoctorForDocuments.documents) return;

            const docName = currentDoctorForDocuments.documents[index].name;
            if (confirm(`هل أنت متأكد من حذف الوثيقة: ${docName}؟`)) {
                currentDoctorForDocuments.documents.splice(index, 1);
                saveData();
                showDoctorDocumentsModal(currentDoctorForDocuments.id); // Refresh modal view
                displayDoctors(); // Refresh table view to update count
                showNotification(`تم حذف الوثيقة: ${docName}`, 'info');
            }
        }

        // === LEAVE MANAGEMENT FUNCTIONS ===

        function addDoctorLeave(doctorId, leaveType) {
            if (!hasPermission('edit')) {
                showPermissionDenied();
                return;
            }
            
            const doctor = doctors.find(d => d.id === doctorId);
            if (!doctor) return;

            currentLeaveDoctor = doctor;
            currentLeaveType = leaveType;

            document.getElementById('leaveDoctorName').value = doctor.name;
            document.getElementById('leaveModalTitle').textContent = 
                leaveType === 'annual' ? 'إضافة إجازة دورية - Add Annual Leave' : 'إضافة إجازة مرضية - Add Sick Leave';

            document.getElementById('leaveModal').classList.remove('hidden');
        }

        function closeLeaveModal() {
            document.getElementById('leaveModal').classList.add('hidden');
            currentLeaveDoctor = null;
            currentLeaveType = '';
            
            ['leaveStartDate', 'leaveEndDate', 'leaveReason'].forEach(id => {
                const element = document.getElementById(id);
                if (element) element.value = '';
            });
            document.getElementById('leaveDaysDisplay').classList.add('hidden');
        }

        function updateLeaveDays() {
            const startDate = document.getElementById('leaveStartDate').value;
            const endDate = document.getElementById('leaveEndDate').value;

            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                if(end < start) {
                    showNotification('تاريخ النهاية يجب أن يكون بعد تاريخ البداية', 'error');
                    document.getElementById('leaveDaysDisplay').classList.add('hidden');
                    return;
                }
                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;

                document.getElementById('leaveDaysCount').textContent = diffDays;
                document.getElementById('leaveDaysDisplay').classList.remove('hidden');
            } else {
                document.getElementById('leaveDaysDisplay').classList.add('hidden');
            }
        }

        function addLeave() {
            if (!hasPermission('edit') || !currentLeaveDoctor) {
                showPermissionDenied();
                return;
            }

            const startDate = document.getElementById('leaveStartDate').value;
            const endDate = document.getElementById('leaveEndDate').value;
            const reason = document.getElementById('leaveReason').value.trim();

            if (!startDate || !endDate) {
                showNotification('يرجى تحديد تاريخ البداية والنهاية', 'error');
                return;
            }

            const start = new Date(startDate);
            const end = new Date(endDate);

            if(end < start) {
                showNotification('تاريخ النهاية يجب أن يكون بعد تاريخ البداية', 'error');
                return;
            }

            const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;

            const leave = {
                id: generateLeaveId(),
                type: currentLeaveType,
                startDate: startDate,
                endDate: endDate,
                days: days,
                reason: reason || `${currentLeaveType === 'annual' ? 'إجازة دورية' : 'إجازة مرضية'}`,
                createdAt: new Date().toISOString()
            };

            if (!currentLeaveDoctor.leaves) {
                currentLeaveDoctor.leaves = [];
            }
            currentLeaveDoctor.leaves.push(leave);

            currentLeaveDoctor.currentStatus = currentLeaveType === 'annual' ? 'annual_leave' : 'sick_leave';

            saveData();
            updateDataDisplay();
            closeLeaveModal();

            showNotification(`تم إضافة ${currentLeaveType === 'annual' ? 'الإجازة الدورية' : 'الإجازة المرضية'} للطبيب: ${currentLeaveDoctor.name}`, 'success');
        }

        function generateLeaveId() {
            return 'LEAVE_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
        }

        function resetDoctorStatus(doctorId) {
            if (!hasPermission('edit')) {
                showPermissionDenied();
                return;
            }
            
            const doctor = doctors.find(d => d.id === doctorId);
            if (!doctor) return;

            if (confirm(`هل تريد إعادة تعيين حالة الطبيب إلى "نشط"؟`)) {
                doctor.currentStatus = 'active';
                saveData();
                updateDataDisplay();
                showNotification(`تم إعادة تعيين حالة الطبيب: ${doctor.name} إلى نشط`, 'success');
            }
        }

        // === LEAVE CALENDAR FUNCTIONS ===

        function generateLeaveCalendar() {
            const currentYear = new Date().getFullYear();
            document.getElementById('currentYear').textContent = currentYear;
            
            generateCalendarHeaders();
            generateCalendarBody();
        }

        function generateCalendarHeaders() {
            const header = document.getElementById('leaveCalendarHeader');
            if (!header) return;

            const headerRow = document.createElement('tr');
            const currentYear = new Date().getFullYear();
            
            const doctorHeader = document.createElement('th');
            doctorHeader.className = 'doctor-name-cell';
            doctorHeader.textContent = 'الأطباء - Doctors';
            headerRow.appendChild(doctorHeader);

            const weekRange = getWeekRange(currentPeriod);
            for (let week = weekRange.start; week <= weekRange.end; week++) {
                const weekHeader = document.createElement('th');
                weekHeader.className = 'week-header';
                
                const firstSunday = getFirstSundayOfWeek(week, currentYear);
                const dateLabel = formatWeekHeader(firstSunday);
                
                weekHeader.innerHTML = `<div>${dateLabel}</div>`;
                weekHeader.title = `الأسبوع ${week} - Week ${week}`;
                headerRow.appendChild(weekHeader);
            }

            header.innerHTML = '';
            header.appendChild(headerRow);
        }

        function generateCalendarBody() {
            const tbody = document.getElementById('leaveCalendarBody');
            if (!tbody) return;

            tbody.innerHTML = '';

            doctors.forEach(doctor => {
                const row = document.createElement('tr');
                
                const nameCell = document.createElement('td');
                nameCell.className = 'doctor-name-cell';
                nameCell.textContent = doctor.name;
                row.appendChild(nameCell);

                const weekRange = getWeekRange(currentPeriod);
                for (let week = weekRange.start; week <= weekRange.end; week++) {
                    const weekCell = document.createElement('td');
                    weekCell.className = 'leave-cell';
                    
                    const leaveInfo = getLeaveForWeek(doctor, week, new Date().getFullYear());
                    
                    if (leaveInfo) {
                        weekCell.classList.add(leaveInfo.type === 'annual' ? 'leave-annual' : 'leave-sick');
                        weekCell.addEventListener('mouseenter', (e) => showLeaveTooltip(e, doctor, leaveInfo));
                        weekCell.addEventListener('mouseleave', hideLeaveTooltip);
                    } else {
                        weekCell.classList.add('leave-empty');
                    }
                    
                    row.appendChild(weekCell);
                }

                tbody.appendChild(row);
            });
        }

        function getWeekRange(period) {
            switch (period) {
                case 'Q1': return { start: 1, end: 13 };
                case 'Q2': return { start: 14, end: 26 };
                case 'Q3': return { start: 27, end: 39 };
                case 'Q4': return { start: 40, end: 52 };
                case 'H1': return { start: 1, end: 26 };
                case 'H2': return { start: 27, end: 52 };
                case 'FULL': return { start: 1, end: 52 };
                default: return { start: 1, end: 13 };
            }
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function getFirstSundayOfWeek(weekNumber, year) {
            const firstDayOfYear = new Date(year, 0, 1);
            const firstSunday = new Date(firstDayOfYear);
            const dayOfWeek = firstDayOfYear.getDay();
            
            if (dayOfWeek === 0) {
                firstSunday.setDate(1);
            } else {
                firstSunday.setDate(1 + (7 - dayOfWeek));
            }
            
            const targetSunday = new Date(firstSunday);
            targetSunday.setDate(firstSunday.getDate() + ((weekNumber - 1) * 7));
            
            return targetSunday;
        }

        function formatWeekHeader(date) {
            const day = date.getDate();
            const month = date.getMonth() + 1;
            return `${day}/${month}`;
        }

        function getLeaveForWeek(doctor, weekNumber, year) {
            if (!doctor.leaves || doctor.leaves.length === 0) return null;

            return doctor.leaves.find(leave => {
                const startDate = new Date(leave.startDate);
                const endDate = new Date(leave.endDate);
                
                const startWeek = getWeekNumber(startDate);
                const endWeek = getWeekNumber(endDate);
                
                return weekNumber >= startWeek && weekNumber <= endWeek;
            });
        }

        function showLeaveTooltip(event, doctor, leaveInfo) {
            const tooltip = document.getElementById('leaveTooltip');
            if (!tooltip) return;

            const typeLabel = leaveInfo.type === 'annual' ? 'إجازة دورية - Annual Leave' : 'إجازة مرضية - Sick Leave';
            
            tooltip.innerHTML = `
                <div class="font-bold">${doctor.name}</div>
                <div class="text-sm mt-1">${typeLabel}</div>
                <div class="text-xs mt-1">
                    <div>من - From: ${formatDate(leaveInfo.startDate)}</div>
                    <div>إلى - To: ${formatDate(leaveInfo.endDate)}</div>
                    <div>المدة - Duration: ${leaveInfo.days} أيام - days</div>
                </div>
                ${leaveInfo.reason ? `<div class="text-xs mt-1 italic">${leaveInfo.reason}</div>` : ''}
            `;

            tooltip.style.left = event.pageX + 10 + 'px';
            tooltip.style.top = event.pageY - 10 + 'px';
            tooltip.classList.remove('hidden');
        }

        function hideLeaveTooltip() {
            const tooltip = document.getElementById('leaveTooltip');
            if (tooltip) {
                tooltip.classList.add('hidden');
            }
        }

        function changePeriod(period, buttonElement) {
            currentPeriod = period;
            
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            buttonElement.classList.add('active');
            
            generateLeaveCalendar();
        }

        function refreshLeaveCalendar() {
            generateLeaveCalendar();
            showNotification('تم تحديث جدول الإجازات', 'success', 2000);
        }

        function exportLeaveCalendar() {
            try {
                const wb = XLSX.utils.book_new();
                const currentYear = new Date().getFullYear();
                
                const exportData = [];
                const weekRange = getWeekRange(currentPeriod);
                
                const headers = ['الطبيب - Doctor'];
                for (let week = weekRange.start; week <= weekRange.end; week++) {
                    const firstSunday = getFirstSundayOfWeek(week, currentYear);
                    const dateLabel = formatWeekHeader(firstSunday);
                    headers.push(`${dateLabel} (W${week})`);
                }
                exportData.push(headers);
                
                doctors.forEach(doctor => {
                    const row = [doctor.name];
                    
                    for (let week = weekRange.start; week <= weekRange.end; week++) {
                        const leaveInfo = getLeaveForWeek(doctor, week, currentYear);
                        if (leaveInfo) {
                            row.push(leaveInfo.type === 'annual' ? 'إجازة دورية' : 'إجازة مرضية');
                        } else {
                            row.push('');
                        }
                    }
                    
                    exportData.push(row);
                });

                const ws = XLSX.utils.aoa_to_sheet(exportData);
                XLSX.utils.book_append_sheet(wb, ws, `إجازات_${currentPeriod}_${currentYear}`);
                
                const fileName = `جدول_الإجازات_المرئي_${currentPeriod}_${currentYear}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showNotification('تم تصدير جدول الإجازات بنجاح', 'success');
                
            } catch (error) {
                console.error('Leave calendar export error:', error);
                showNotification('خطأ في تصدير جدول الإجازات', 'error');
            }
        }

        async function exportLeaveCalendarPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const target = document.querySelector('#leaveCalendarMode .bg-white.rounded-lg.shadow-md.overflow-hidden');
                if (!target) {
                    showNotification('تعذر العثور على جدول الإجازات', 'error');
                    return;
                }

                const canvas = await html2canvas(target, { scale: 2, useCORS: true });
                const img = canvas.toDataURL('image/png');
                const pdf = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });
                
                const pw = pdf.internal.pageSize.getWidth();
                const ph = pdf.internal.pageSize.getHeight();
                const m = 24;
                const w = pw - m * 2;
                const h = canvas.height * (w / canvas.width);
                
                if (h > ph - m * 2) {
                    const s = (ph - m * 2) / h;
                    const aw = w * s, ah = h * s, x = (pw - aw) / 2;
                    pdf.addImage(img, 'PNG', x, m, aw, ah, '', 'FAST');
                } else {
                    pdf.addImage(img, 'PNG', m, m, w, h, '', 'FAST');
                }
                
                pdf.save('leave_calendar.pdf');
                showNotification('تم تصدير PDF بنجاح', 'success');
            } catch (error) {
                console.error('PDF export error:', error);
                showNotification('حدث خطأ أثناء إنشاء PDF', 'error');
            }
        }

        // === REPORT GENERATION FUNCTIONS ===

        function toggleReportBuilder() {
            const reportBuilder = document.getElementById('reportBuilder');
            if (reportBuilder) {
                if (reportBuilder.classList.contains('hidden')) {
                    reportBuilder.classList.remove('hidden');
                    showNotification('تم فتح منشئ التقارير المُصلح', 'info', 2000);
                } else {
                    reportBuilder.classList.add('hidden');
                }
            }
        }

        function showReportProgress() {
            const progressDiv = document.getElementById('reportProgress');
            if (progressDiv) {
                progressDiv.style.display = 'block';
                updateProgress(0, 'بدء إنشاء التقرير...');
            }
        }

        function updateProgress(percent, text) {
            const progressText = document.getElementById('progressText');
            const progressPercent = document.getElementById('progressPercent');
            const progressFill = document.getElementById('progressFill');

            if (progressText) progressText.textContent = text;
            if (progressPercent) progressPercent.textContent = `${percent}%`;
            if (progressFill) progressFill.style.width = `${percent}%`;
        }

        function hideReportProgress() {
            const progressDiv = document.getElementById('reportProgress');
            if (progressDiv) {
                progressDiv.style.display = 'none';
            }
        }

        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const exportFormat = document.getElementById('exportFormat').value;

            if (!reportType || !exportFormat) {
                showNotification('يرجى اختيار نوع التقرير والصيغة', 'warning');
                return;
            }

            showReportProgress();

            setTimeout(() => {
                updateProgress(50, 'جاري تحضير البيانات...');
                
                setTimeout(() => {
                    updateProgress(100, 'تم إكمال التقرير بنجاح!');
                    
                    setTimeout(() => {
                        hideReportProgress();
                        const centerName = prompt('أدخل اسم المركز الطبي:', 'مركز الرعاية الصحية الأولية') || 'مركز الرعاية الصحية الأولية';
                        
                        try {
                            const reportData = generateReportData(reportType, centerName);
                            
                            switch (exportFormat) {
                                case 'excel':
                                    exportToExcel(reportData, reportType);
                                    break;
                                case 'csv':
                                    exportToCSV(reportData, reportType);
                                    break;
                                case 'pdf':
                                    exportToPDF(reportData, reportType);
                                    break;
                                case 'json':
                                    exportToJSON(reportData, reportType);
                                    break;
                            }
                            
                            showNotification(`تم إنشاء تقرير ${exportFormat.toUpperCase()} بنجاح!`, 'success');
                        } catch (error) {
                            console.error('Report generation error:', error);
                            showNotification('خطأ في إنشاء التقرير', 'error');
                        }
                    }, 1000);
                }, 1000);
            }, 500);
        }

        function generateReportData(reportType, centerName) {
            const timestamp = new Date().toISOString();
            
            const basicData = doctors.map((doctor, index) => {
                let arabicName = 'طبيب غير محدد';
                let englishName = 'Doctor';
                
                if (doctor.name) {
                    if (doctor.name.includes(' - ')) {
                        const parts = doctor.name.split(' - ');
                        arabicName = parts[0].trim();
                        englishName = parts[1].trim();
                    } else {
                        arabicName = doctor.name;
                        englishName = doctor.name;
                    }
                }

                return {
                    'م': index + 1,
                    'اسم الطبيب': arabicName,
                    'Doctor Name': englishName,
                    'رقم الملف': doctor.fileNumber || 'غير محدد',
                    'File Number': doctor.fileNumber || 'Not Specified',
                    'الرقم المدني': doctor.civilId || 'غير محدد',
                    'Civil ID': doctor.civilId || 'Not Specified',
                    'المسمى الوظيفي': extractArabicText(doctor.jobTitle),
                    'Job Title': extractEnglishText(doctor.jobTitle),
                    'التليفون': doctor.phone || 'غير محدد',
                    'Phone': doctor.phone || 'Not Specified',
                    'البريد الإلكتروني': doctor.personalEmail || 'غير محدد',
                    'Email': doctor.personalEmail || 'Not Specified',
                    'تاريخ انتهاء ACLS': doctor.aclsExpiryDate ? formatDate(doctor.aclsExpiryDate) : 'غير محدد',
                    'ACLS Expiry': doctor.aclsExpiryDate ? formatDate(doctor.aclsExpiryDate) : 'Not Specified',
                    'الحالة الحالية': getArabicStatus(doctor.currentStatus),
                    'Current Status': getEnglishStatus(doctor.currentStatus)
                };
            });

            return {
                metadata: {
                    'اسم المركز': centerName,
                    'Center Name': centerName,
                    'نوع التقرير': getArabicReportType(reportType),
                    'Report Type': getEnglishReportType(reportType),
                    'تاريخ الإنشاء': formatDate(timestamp),
                    'Generated Date': formatDate(timestamp),
                    'عدد السجلات': doctors.length,
                    'Record Count': doctors.length
                },
                data: basicData,
                reportType: reportType,
                centerName: centerName
            };
        }

        function extractArabicText(text) {
            if (!text) return 'غير محدد';
            if (text.includes(' - ')) {
                return text.split(' - ')[0].trim();
            }
            return text;
        }

        function extractEnglishText(text) {
            if (!text) return 'Not Specified';
            if (text.includes(' - ')) {
                return text.split(' - ')[1].trim();
            }
            return text;
        }

        function getArabicStatus(status) {
            const statusMap = {
                'active': 'نشط',
                'annual_leave': 'إجازة دورية',
                'sick_leave': 'إجازة مرضية'
            };
            return statusMap[status] || 'غير محدد';
        }

        function getEnglishStatus(status) {
            const statusMap = {
                'active': 'Active',
                'annual_leave': 'Annual Leave',
                'sick_leave': 'Sick Leave'
            };
            return statusMap[status] || 'Not Specified';
        }

        function getArabicReportType(reportType) {
            const types = {
                'basic': 'تقرير الأطباء الأساسي',
                'detailed': 'تقرير الأطباء المفصل',
                'leaves': 'تقرير إجازات الأطباء',
                'acls': 'تقرير شهادات ACLS',
                'comprehensive': 'تقرير شامل للأطباء',
                'statistics': 'تقرير الإحصائيات'
            };
            return types[reportType] || 'تقرير الأطباء';
        }

        function getEnglishReportType(reportType) {
            const types = {
                'basic': 'Basic Doctors Report',
                'detailed': 'Detailed Doctors Report',
                'leaves': 'Doctors Leave Report',
                'acls': 'ACLS Certificates Report',
                'comprehensive': 'Comprehensive Doctors Report',
                'statistics': 'Statistics Report'
            };
            return types[reportType] || 'Doctors Report';
        }

        // === EXPORT FUNCTIONS ===

        function exportToExcel(reportData, reportType) {
            try {
                const wb = XLSX.utils.book_new();
                
                // Filter data to keep only Arabic keys
                const arabicKeys = [
                    'م', 'اسم الطبيب', 'رقم الملف', 'الرقم المدني', 'المسمى الوظيفي',
                    'التليفون', 'البريد الإلكتروني', 'تاريخ انتهاء ACLS', 'الحالة الحالية'
                ];

                const arabicData = reportData.data.map(item => {
                    const newItem = {};
                    arabicKeys.forEach(key => {
                        newItem[key] = item[key] || '';
                    });
                    return newItem;
                });
                
                const ws = XLSX.utils.json_to_sheet(arabicData, { header: arabicKeys });
                
                // Add metadata header
                const metadata = reportData.metadata;
                const headerText = `${metadata['اسم المركز']} - ${metadata['نوع التقرير']} - ${new Date().toLocaleDateString('ar-EG')}`;
                XLSX.utils.sheet_add_aoa(ws, [[headerText]], { origin: "A1" });
                ws['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: arabicKeys.length - 1 } }];
                
                // Start the table data from the third row
                XLSX.utils.sheet_add_json(ws, arabicData, { origin: 'A3', skipHeader: false, header: arabicKeys });

                XLSX.utils.book_append_sheet(wb, ws, "البيانات الرئيسية");

                const fileName = `${reportData.centerName.replace(/\s+/g, '_')}_${getArabicReportType(reportType).replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
            } catch (error) {
                console.error('Excel export error:', error);
                showNotification('خطأ في تصدير Excel', 'error');
            }
        }

        function exportToCSV(reportData, reportType) {
            try {
                const BOM = '\uFEFF';
                let csvContent = '';
                
                if (reportData.data && reportData.data.length > 0) {
                    const headers = Object.keys(reportData.data[0]);
                    csvContent += headers.map(header => `"${header}"`).join(',') + '\n';
                    
                    reportData.data.forEach(row => {
                        const values = headers.map(header => {
                            let value = row[header];
                            if (value === null || value === undefined) {
                                value = '';
                            }
                            value = value.toString().replace(/"/g, '""');
                            return `"${value}"`;
                        });
                        csvContent += values.join(',') + '\n';
                    });
                }
                
                const csvWithBOM = BOM + csvContent;
                const blob = new Blob([csvWithBOM], { type: 'text/csv;charset=utf-8;' });
                
                const link = document.createElement('a');
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    const fileName = `${reportData.centerName.replace(/\s+/g, '_')}_${getArabicReportType(reportType).replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
                    link.setAttribute('href', url);
                    link.setAttribute('download', fileName);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }
            } catch (error) {
                console.error('CSV export error:', error);
                showNotification('خطأ في تصدير CSV', 'error');
            }
        }

        function exportToPDF(reportData, reportType) {
            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                
                const marginMm = 10;
                const pageWidthMm = 210;
                const pageHeightMm = 297;
                const contentWidthMm = pageWidthMm - marginMm * 2;
                const pxPerMm = 3.7795275591;
                const mmToPx = mm => Math.round(mm * pxPerMm);

                const container = document.createElement('div');
                container.setAttribute('dir', 'rtl');
                container.style.position = 'fixed';
                container.style.left = '-10000px';
                container.style.top = '0';
                container.style.width = mmToPx(contentWidthMm) + 'px';
                container.style.padding = '16px';
                container.style.background = '#ffffff';
                container.style.color = '#111827';
                container.style.fontFamily = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
                container.style.lineHeight = '1.6';
                container.style.boxSizing = 'border-box';

                const center = reportData.centerName || 'المركز';
                const header = document.createElement('div');
                header.style.textAlign = 'center';
                header.style.marginBottom = '12px';
                header.innerHTML = `
                    <div style="font-size:20px; font-weight:700;">${center}</div>
                    <div style="font-size:14px; margin-top:6px;">${new Date().toLocaleDateString('ar-EG')}</div>
                    <hr style="margin-top:8px; border:none; border-top:1px solid #e5e7eb;">
                `;
                container.appendChild(header);

                const body = document.createElement('div');
                const rows = reportData.data || [];
                rows.forEach((item, i) => {
                    const card = document.createElement('div');
                    card.style.border = '1px solid #e5e7eb';
                    card.style.borderRadius = '8px';
                    card.style.padding = '10px';
                    card.style.margin = '8px 0';
                    card.style.background = '#ffffff';
                    const name = item['اسم الطبيب'] || item['Doctor Name'] || `سجل ${i+1}`;
                    card.innerHTML = `<div style="font-weight:700; margin-bottom:6px;">${i+1}. ${name}</div>`;
                    
                    Object.keys(item).forEach(k => {
                        if (['اسم الطبيب', 'Doctor Name', 'م'].includes(k)) return;
                        const v = item[k];
                        card.innerHTML += `<div style="display:flex; gap:8px; flex-wrap:wrap; font-size: 12px;"><div style="font-weight:600;">${k}:</div><div>${(v==null?'':v)}</div></div>`;
                    });
                    body.appendChild(card);
                });
                container.appendChild(body);
                document.body.appendChild(container);

                html2canvas(container, { backgroundColor: '#ffffff', scale: 2, useCORS: true, allowTaint: true })
                .then(canvas => {
                    document.body.removeChild(container);
                    const pageHeightPx = mmToPx(pageHeightMm - marginMm * 2);
                    const fullWidthPx = canvas.width;
                    const fullHeightPx = canvas.height;

                    let y = 0;
                    let page_index = 0;
                    while (y < fullHeightPx) {
                        const sliceHeight = Math.min(pageHeightPx, fullHeightPx - y);
                        const pageCanvas = document.createElement('canvas');
                        pageCanvas.width = fullWidthPx;
                        pageCanvas.height = sliceHeight;
                        const pageCtx = pageCanvas.getContext('2d');
                        pageCtx.drawImage(canvas, 0, y, fullWidthPx, sliceHeight, 0, 0, fullWidthPx, sliceHeight);
                        
                        const imgData = pageCanvas.toDataURL('image/png');
                        const imgHeightMm = (sliceHeight / pxPerMm);
                        const imgWidthMm = (fullWidthPx / pxPerMm);
                        const scale = contentWidthMm / imgWidthMm;
                        const renderHeightMm = imgHeightMm * scale;
                        
                        if (page_index > 0) pdf.addPage();
                        pdf.addImage(imgData, 'PNG', marginMm, marginMm, contentWidthMm, renderHeightMm);
                        
                        y += sliceHeight;
                        page_index += 1;
                    }

                    const fileName = `${center.toString().replace(/\s+/g,'_')}_${getArabicReportType(reportType).replace(/\s+/g, '_')}.pdf`;
                    pdf.save(fileName);
                    
                })
                .catch(err => {
                    console.error('PDF export error:', err);
                    if (document.body.contains(container)) {
                        document.body.removeChild(container);
                    }
                    showNotification('خطأ في تصدير PDF', 'error');
                });
            } catch (err) {
                console.error('PDF export fatal error:', err);
                showNotification('خطأ فادح في تصدير PDF', 'error');
            }
        }

        function exportToJSON(reportData, reportType) {
            try {
                const jsonData = {
                    تقرير_النظام: {
                        اسم_المركز: reportData.centerName,
                        نوع_التقرير: getArabicReportType(reportType),
                        تاريخ_الإنشاء: formatDate(new Date()),
                        إصدار_النظام: 'v3.0 Enhanced with Arabic Support'
                    },
                    بيانات_الأطباء: reportData.data
                };
                
                const jsonString = JSON.stringify(jsonData, null, 2);
                const BOM = '\uFEFF';
                const jsonWithBOM = BOM + jsonString;
                
                const blob = new Blob([jsonWithBOM], { type: 'application/json;charset=utf-8' });
                
                const link = document.createElement('a');
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    const fileName = `${reportData.centerName.replace(/\s+/g, '_')}_${getArabicReportType(reportType).replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.json`;
                    link.setAttribute('href', url);
                    link.setAttribute('download', fileName);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            } catch (error) {
                console.error('JSON export error:', error);
                showNotification('خطأ في تصدير JSON', 'error');
            }
        }

        // === SETTINGS FUNCTIONS ===

        function showSettingsModal() {
            const currentUsernameInput = document.getElementById('currentUsername');
            if (currentUsernameInput && currentUser) {
                currentUsernameInput.value = currentUser.email || 'مستخدم النظام';
            }
            document.getElementById('settingsModal').classList.remove('hidden');
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.add('hidden');
            ['newPassword', 'confirmPassword'].forEach(id => {
                const element = document.getElementById(id);
                if (element) element.value = '';
            });
        }

        function updateSettings() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword) {
                if (newPassword !== confirmPassword) {
                    showNotification('كلمة المرور الجديدة غير متطابقة', 'error');
                    return;
                }

                if (newPassword.length < 8) {
                    showNotification('كلمة المرور يجب أن تكون 8 أحرف على الأقل', 'error');
                    return;
                }

                // هنا يمكن إضافة منطق تحديث كلمة المرور في Supabase
                showNotification('تم حفظ الإعدادات بنجاح', 'success');
            }

            closeSettingsModal();
        }

        function showUserProfile() {
            showNotification('الملف الشخصي قيد التطوير', 'info');
        }

        // === BACKUP FUNCTIONS ===

        function createManualBackup() {
            try {
                const backupData = {
                    version: '3.0',
                    timestamp: new Date().toISOString(),
                    doctors: doctors,
                    settings: systemSettings,
                    columnConfiguration: displayedColumns
                };

                const jsonString = JSON.stringify(backupData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const link = document.createElement('a');
                
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    const fileName = `نسخة_احتياطية_Backup_${formatDate(new Date()).replace(/\//g, '-')}.json`;
                    link.setAttribute('href', url);
                    link.setAttribute('download', fileName);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    systemSettings.lastBackup = new Date().toISOString();
                    localStorage.setItem('systemSettings', JSON.stringify(systemSettings));
                    updateLastBackupInfo();

                    showNotification('تم إنشاء النسخة الاحتياطية بنجاح', 'success');
                }
            } catch (error) {
                console.error('Backup creation error:', error);
                showNotification('خطأ في إنشاء النسخة الاحتياطية', 'error');
            }
        }

        function showImportBackup() {
            document.getElementById('backupFileInput').click();
        }

        function processBackupFile() {
            const fileInput = document.getElementById('backupFileInput');
            const file = fileInput.files[0];
            
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    if (validateBackupData(backupData)) {
                        if (confirm('هل تريد استيراد هذه النسخة الاحتياطية؟ سيتم استبدال البيانات الحالية.')) {
                            importBackupData(backupData);
                        }
                    } else {
                        showNotification('ملف النسخة الاحتياطية غير صحيح', 'error');
                    }
                } catch (error) {
                    console.error('Backup file processing error:', error);
                    showNotification('خطأ في معالجة ملف النسخة الاحتياطية', 'error');
                }
            };
            
            reader.readAsText(file);
            fileInput.value = '';
        }

        function validateBackupData(data) {
            return data && 
                   data.version && 
                   Array.isArray(data.doctors) && 
                   data.timestamp;
        }

        function importBackupData(backupData) {
            try {
                doctors = backupData.doctors || [];
                systemSettings = { ...systemSettings, ...backupData.settings };
                displayedColumns = backupData.columnConfiguration || displayedColumns;

                saveData();
                localStorage.setItem('systemSettings', JSON.stringify(systemSettings));
                localStorage.setItem('columnConfiguration', JSON.stringify(displayedColumns));

                updateDataDisplay();
                updateLastBackupInfo();

                showNotification(`تم استيراد النسخة الاحتياطية بنجاح - ${backupData.doctors.length} سجل`, 'success');

            } catch (error) {
                console.error('Backup import error:', error);
                showNotification('خطأ في استيراد النسخة الاحتياطية', 'error');
            }
        }

        function updateLastBackupInfo() {
            const lastBackupElement = document.getElementById('lastBackupInfo');
            if (lastBackupElement && systemSettings.lastBackup) {
                const backupDate = new Date(systemSettings.lastBackup);
                lastBackupElement.textContent = formatDate(backupDate);
            }
        }

        // === FILE UPLOAD FUNCTIONS ===

        function showUploadModal() {
            document.getElementById('uploadModal').classList.remove('hidden');
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').classList.add('hidden');
        }

        function processUploadedFile() {
            const excelFile = document.getElementById('uploadExcelFile').files[0];
            const csvFile = document.getElementById('uploadCSVFile').files[0];

            if (excelFile && csvFile) {
                showNotification('يرجى اختيار نوع ملف واحد فقط', 'warning');
                return;
            }

            if (excelFile) {
                processExcelFile(excelFile);
            } else if (csvFile) {
                processCSVFile(csvFile);
            } else {
                showNotification('يرجى اختيار ملف للرفع', 'warning');
            }
        }

        function processExcelFile(file) {
            showNotification('معالجة ملفات Excel قيد التطوير', 'info');
        }

        function processCSVFile(file) {
            showNotification('معالجة ملفات CSV قيد التطوير', 'info');
        }

        // === ANALYTICS FUNCTIONS ===

        function destroyCharts() {
            Object.keys(activeCharts).forEach(key => {
                if(activeCharts[key]) {
                    activeCharts[key].destroy();
                }
            });
            activeCharts = {};
        }

        function showAdvancedAnalytics() {
            document.getElementById('analyticsModal').classList.remove('hidden');
            generateAnalyticsCharts();
        }

        function closeAnalyticsModal() {
            document.getElementById('analyticsModal').classList.add('hidden');
            destroyCharts();
        }

        function generateAnalyticsCharts() {
            destroyCharts(); // Clear previous charts
            
            // 1. Status Chart (Pie)
            const statusCounts = doctors.reduce((acc, doc) => {
                const status = getArabicStatus(doc.currentStatus);
                acc[status] = (acc[status] || 0) + 1;
                return acc;
            }, {});

            const statusCtx = document.getElementById('statusChart').getContext('2d');
            activeCharts.statusChart = new Chart(statusCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        label: 'حالة الأطباء',
                        data: Object.values(statusCounts),
                        backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6'],
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { labels: { color: 'white' } } }
                }
            });

            // 2. ACLS Chart (Bar)
            const today = new Date();
            const aclsStatus = { 'صالح': 0, 'ينتهي قريباً': 0, 'منتهي': 0, 'غير محدد': 0 };
            doctors.forEach(doctor => {
                if (!doctor.aclsExpiryDate) {
                    aclsStatus['غير محدد']++;
                    return;
                }
                const expiry = new Date(doctor.aclsExpiryDate);
                const daysUntilExpiry = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
                if (daysUntilExpiry < 0) aclsStatus['منتهي']++;
                else if (daysUntilExpiry <= 30) aclsStatus['ينتهي قريباً']++;
                else aclsStatus['صالح']++;
            });

            const aclsCtx = document.getElementById('aclsChart').getContext('2d');
            activeCharts.aclsChart = new Chart(aclsCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(aclsStatus),
                    datasets: [{
                        label: 'حالة شهادة ACLS',
                        data: Object.values(aclsStatus),
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#9ca3af'],
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { ticks: { color: 'white' } }, x: { ticks: { color: 'white' } } }
                }
            });

            // 3. Job Title Chart (Doughnut)
            const jobTitleCounts = doctors.reduce((acc, doc) => {
                const title = extractArabicText(doc.jobTitle) || 'غير محدد';
                acc[title] = (acc[title] || 0) + 1;
                return acc;
            }, {});
            
            const jobTitleCtx = document.getElementById('jobTitleChart').getContext('2d');
            activeCharts.jobTitleChart = new Chart(jobTitleCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(jobTitleCounts),
                    datasets: [{
                        label: 'المسميات الوظيفية',
                        data: Object.values(jobTitleCounts),
                        backgroundColor: ['#3b82f6', '#10b981', '#8b5cf6', '#d97706', '#14b8a6', '#6366f1'],
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { labels: { color: 'white' } } }
                }
            });
        }

        function exportAllData() {
            const allData = {
                doctors: doctors,
                settings: systemSettings,
                columns: displayedColumns,
                exportDate: new Date().toISOString(),
                version: '3.0'
            };
            
            exportToJSON({ ...allData, centerName: 'بيانات كاملة', reportType: 'complete_data' }, 'complete_data');
        }
        
        // === PDF TABLE EXPORT ===
        function exportTableToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Filter for visible columns and prepare headers
            const headers = displayedColumns
                .filter(col => col.enabled && col.type !== 'actions' && col.type !== 'documents')
                .map(col => col.label.split(' - ')[0]); // Get Arabic part of label

            // Prepare body rows
            const body = (doctors).map(doctor => {
                return displayedColumns
                    .filter(col => col.enabled && col.type !== 'actions' && col.type !== 'documents')
                    .map(col => {
                        let value = doctor[col.key] || ' ';
                        if (col.key === 'currentStatus') {
                            value = getArabicStatus(doctor.currentStatus);
                        } else if (col.type === 'date' && value !== ' ') {
                            value = new Date(value).toLocaleDateString('ar-EG');
                        }
                        return value.toString().split(' - ')[0]; // Ensure only Arabic part is taken
                    });
            });

            doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Amiri', 'normal');
            doc.setFont('Amiri');
            
            doc.autoTable({
                head: [headers],
                body: body,
                styles: {
                    font: 'Amiri',
                    halign: 'center',
                },
                headStyles: {
                    fillColor: [41, 128, 185],
                    textColor: 255,
                    fontStyle: 'bold',
                },
                didDrawPage: function(data) {
                    // Header
                    doc.setFontSize(20);
                    doc.setTextColor(40);
                    doc.text('قائمة الأطباء', data.settings.margin.left, 15);

                    // Footer
                    let str = "Page " + doc.internal.getNumberOfPages();
                    doc.setFontSize(10);
                    doc.text(str, data.settings.margin.left, doc.internal.pageSize.height - 10);
                },
                margin: { top: 20 },
            });

            doc.save('doctors_list.pdf');
            showNotification('تم تصدير قائمة الأطباء إلى PDF بنجاح!', 'success');
        }


        // === SYSTEM INITIALIZATION ===

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🩺 نظام إدارة الأطباء المطور v3.0 مع مصادقة Supabase آمنة');
            
            try {
                setupAuthListener();
                const isAuthenticated = await checkAuthState();
                
                if (!isAuthenticated) {
                    document.getElementById('authScreen').classList.remove('hidden');
                }
            } catch (error) {
                console.error('System initialization error:', error);
                showNotification(
                    '❌ خطأ في تهيئة النظام\n' +
                    'سيتم تشغيل النظام التجريبي',
                    'error'
                );
                
                document.getElementById('authScreen').classList.remove('hidden');
            }
        });

        console.log(`
        ✅ نظام إدارة الأطباء المطور v3.0 - مُكون بالكامل!
        Enhanced Physicians Management System v3.0 - Fully Configured!
        
        🔗 Supabase Project: gwnzqfmnvplwnaydwelt.supabase.co
        
        👑 المديرون - Administrators (Full Access):
           📧 abdo@post.com
           📧 qasercenter@gmail.com
        
        👁️ المستخدمون - Users (Read Only):
           📧 phcjahra@gmail.com
        
        🚀 الميزات المفعلة - Active Features:
        ✅ مصادقة Supabase آمنة
        ✅ نظام صلاحيات متعدد المستويات
        ✅ دعم كامل للعربية
        ✅ واجهة محسنة
        ✅ أمان متقدم
        ✅ جميع الوظائف مفعلة
        
        📝 الصلاحيات - Permissions:
        • Full Access: إضافة، تعديل، حذف، عرض جميع التقارير
        • Read Only: عرض، بحث، تصدير فقط
        `);

    </script>
</body>
</html>